---
outline: deep
order: 3
---

# 支付

## 概述

支付系统是一个用于处理各种支付和转账操作的核心平台，旨在为商户提供高效、安全、可靠的支付解决方案。该系统支持多种支付渠道，并具备灵活的业务处理能力，以满足不同场景下的支付需求。

## 目标

- **通用的支付组件** 能为企业、应用提供支付能力的基础设施组件，为上层应用快速的集成支付能力
- **支付中台** 能够将支付渠道与商户应用进行关联，为企业业务提供整体支付能力

## 统一语言表

|    术语    |       英文       | 描述                                               |
|:--------:|:--------------:|--------------------------------------------------|
|  **商户**  |    Merchant    | 在支付系统下创建的独立权限的用户                                 |
| **商户应用** |  MerchantApp   | 商户创建的应用                                          |
| **渠道应用** |   ChannelApp   | 在支付渠道下一个商户创建的一个支付应用，主要和支付渠道交互                    |
|  **交易**  |     Trans      | 商户发起的支付收单                                        |
|  **退款**  |     Refund     | 支付渠道发起的支付收单                                      |
|  **转账**  |    Transfer    | 商户发起的使用支付渠道的商户余额向指定收款人、金额的转账                     |
| **支付渠道** |    Channel     | 支付系统的支付渠道，如各大银行、微信、支付宝、银联、翼支付等。支付渠道有收单和退款能力      |
| **支付方式** |     Method     | 支付渠道支持的支付方式，如微信、支付宝、银行卡等                         |
| **支付场景** |  PaymentScene  | 用户在支付流程中使用的支付场景，如APP、PC、小程序、H5、APP-NATIVE等       |
| **支付路由** | PaymentRouting | 用户在发起支付时，支付系统根据用户选择的支付场景，选择合适的支付渠道和支付方式，最终发起支付请求 |
|  **对账**  | Reconciliation | 支付系统对支付渠道发起的支付请求，支付渠道返回的支付结果，支付系统对支付结果的处理，最终对账   |

## 系统架构

```plantuml
@startuml

component 系统架构 {

card 应用 {
node 聚合支付平台
node 应用支付模块
node 企业支付中台

}


card 核心能力{
component 支付
component 退款
component 转账
component 分账
component 对账

}

card 支付渠道{
	component 支付宝
	component 微信
	component XXX
}
应用 --> 核心能力

核心能力 -- 支付渠道

}

@enduml
	
```

## 核心模型

```plantuml
@startuml


cloud 商户系统{
}
cloud 支付渠道{
}


package 支付核心领域 {

object 支付渠道商户{
	- 渠道
	- 商户
}
object 支付渠道应用{
	- 渠道
	- 应用ID
	- 密钥证书
}
支付渠道商户 *..> 支付渠道应用: 归属
class 商户{
- 商户号
}
class 商户应用{
- 应用ID
+ 使用渠道应用()
}
class 商户分账关系{
- 分账关系
- 名称
}
class 商户分账关系渠道映射{
- 渠道
- 渠道商户
- 账户类型
- 账户
}
商户应用 ..> 商户分账关系:绑定
商户分账关系 *..> 商户分账关系渠道映射: 1:N
支付渠道应用 *.> 商户应用: 渠道应用授权



商户 *-->  商户应用:拥有


entity 交易单 <<聚合根>>{
 - 交易号
 - 金额
}

entity 退款单 <<聚合根>>{
- 退款单号
- 交易
- 金额
}
交易单 *-> 退款单: 限制

entity 转账单 <<聚合根>>{
- 转账单号
- 收款人
- 金额
}

entity 异步通知{
- 通知类型
- 通知地址
+ 重试()
}

<> 核心节点


class 支付渠道服务  << Service >>{
- 支付渠道
- 支付渠道应用
+ 支付()
+ 退款()
+ 转账()
+ 对账()
}

class 支付路由 << Service >> {
	- 支付场景
	- 支付方式
	+ 过滤支付方式()
	+ 过滤渠道应用()
}

enum 支付场景{
+ 平台管理()
}
enum 支付方式{
+ 平台管理()
}


class 对账 << Service >> {
+下载对账单()
+对账()
}

商户应用 ..> 交易单: 发起支付
商户应用 ..> 退款单: 申请退款
商户应用 ..> 转账单: 发起转账


交易单 ..> 核心节点
退款单 ..> 核心节点 
转账单 ..> 核心节点 

核心节点 <..  异步通知: 监听事件

核心节点 -> 支付渠道服务




交易单 --> 支付路由: 发起支付
支付场景 -> 支付路由
支付路由 --> 支付方式: 路由

支付方式 ..> 支付渠道应用: 选优

支付路由 .> 核心节点: 连接




支付渠道应用 ---> 对账:发起对账 

}

支付核心领域.异步通知 .> 商户系统
支付核心领域.支付渠道服务 .> 支付渠道
@enduml
```

- 支付渠道应用 可以由管理员创建，授权给商户商用、也可以由商户创建，授权给商户商用。具体逻辑可以由上层应用来决定。支付领域模型中，只做支付渠道应用授权给商户使用
- 所有的商户应用继承了商户的所有支付渠道应用权限

## 边界上下文
