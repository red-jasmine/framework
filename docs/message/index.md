# 消息领域设计方案

## 1. 引言

### 1.1 背景介绍

消息系统是Red Jasmine Framework中的核心业务领域之一，在现代电商平台中扮演着关键的沟通桥梁角色。随着业务的快速发展，平台需要处理海量的消息通知、推送和用户交互，包括订单状态变更、营销活动推广、系统告警通知等多种场景。传统的消息处理方式已无法满足多业务线、高并发、实时性的要求，因此需要构建一个统一、高效、可扩展的消息领域系统。

### 1.2 问题域

本消息领域主要解决以下四个核心问题：

1. **多业务线消息统一管理问题**: 用户端、商家端、管理端、系统端各业务线消息分散，缺乏统一的管理和配置机制
2. **多渠道推送协调问题**: APP内消息、推送通知、邮件、短信等多种推送渠道缺乏统一调度和状态管理
3. **高并发消息处理问题**: 在业务高峰期，消息发送量激增，系统需要保证高性能和高可靠性
4. **消息模板和规则管理问题**: 缺乏灵活的消息模板系统和智能的推送规则引擎

### 1.3 业务价值

消息领域为业务带来以下四个核心价值：

1. **提升用户体验价值**: 通过及时、准确的消息推送，提升用户对平台服务的感知和满意度
2. **增强业务运营价值**: 通过精准的营销消息和运营通知，提升业务转化率和用户活跃度
3. **保障系统稳定价值**: 通过实时的系统监控和告警消息，保障平台的稳定运行
4. **降低运营成本价值**: 通过自动化的消息处理和智能推送规则，降低人工运营成本

### 1.4 项目目标

#### 1.4.1 业务目标

- **多业务线支持**: 支持用户端、商家端、管理端、系统端四大业务线的统一消息管理
- **多渠道推送**: 实现APP内消息、推送通知、邮件、短信等多种推送渠道的协调配置
- **智能化推送**: 基于用户偏好和行为数据，实现智能化的消息推送策略
- **实时性保障**: 确保关键消息的实时推送，提升用户体验

#### 1.4.2 技术目标

- **高性能**: 支持高并发消息发送，查询响应时间 < 100ms，消息发送QPS > 10000
- **高可靠性**: 消息发送成功率 > 99.9%，消息不丢失、不重复，支持事务保证
- **可扩展性**: 支持水平扩展和插件化扩展，支持多租户架构
- **安全性**: 消息内容加密存储，用户隐私保护，操作日志审计

### 1.5 适用范围

本设计方案适用于Red Jasmine Framework框架下的消息系统建设，包括但不限于：
- 订单状态通知、营销消息推送、系统告警通知等业务场景
- 支持Laravel 12.0+和PHP 8.4+的技术环境
- 需要高并发、高可靠性消息处理能力的电商平台

## 2. 领域建模

### 2.1 领域分析

消息领域的核心业务流程包括消息的创建、发送、推送、阅读和管理等环节。整个流程从应用发起消息创建开始，经过模板处理、规则验证、多渠道推送，最终到达用户并完成阅读确认。系统需要保证消息在整个生命周期中的一致性和可靠性。

**核心业务流程:**
1. **消息创建流程**: 应用根据业务事件创建消息，支持模板化和个性化内容
2. **消息推送流程**: 根据推送规则和用户偏好，选择合适的推送渠道进行消息推送
3. **消息管理流程**: 用户对消息进行查看、标记、归档等管理操作
4. **消息监控流程**: 系统对消息发送状态、推送效果进行实时监控和统计分析

### 2.2 核心能力

#### 2.2.1 消息管理能力

- **消息生命周期管理**: 提供消息从创建到归档的完整生命周期管理，包括状态跟踪和自动化处理
- **消息分类管理**: 支持多层级的消息分类体系，便于消息的组织和用户的查找
- **消息模板管理**: 提供可视化的模板编辑和变量替换功能，支持富文本和多媒体内容

#### 2.2.2 推送调度能力

- **多渠道推送调度**: 统一管理APP内消息、推送通知、邮件、短信等多种推送渠道
- **智能推送策略**: 基于用户行为和偏好数据，智能选择最优推送时机和渠道
- **推送状态跟踪**: 实时跟踪推送状态，支持失败重试和异常处理

#### 2.2.3 规则引擎能力

- **推送规则配置**: 支持基于时间、频率、用户属性等多维度的推送规则配置
- **消息过滤引擎**: 提供灵活的消息过滤和路由机制，确保消息精准投递
- **频率控制机制**: 防止消息骚扰，支持全局和个性化的频率控制策略

### 2.3 领域参与角色

#### 2.3.1 内部角色

- **消息应用**: 发起消息的业务应用系统，负责根据业务事件创建和发送消息
- **消息管理员**: 负责消息系统的配置管理，包括应用管理、分类管理、模板管理等
- **运营人员**: 负责营销消息的策划和发送，监控消息推送效果和用户反馈
- **系统监控员**: 负责消息系统的运行监控，处理系统告警和异常情况
- **业务开发人员**: 负责消息相关功能的开发和维护，包括新渠道接入和功能扩展

#### 2.3.2 外部角色

- **消息接收用户**: 接收和处理消息的最终用户，包括普通用户、商家用户等
- **第三方推送服务**: 提供推送通知、邮件、短信等服务的外部供应商
- **监控告警系统**: 外部的系统监控和告警平台，接收消息系统的运行状态信息

### 2.4 连接领域

#### 2.4.1 上游领域

- **用户领域**: 提供用户基础信息、偏好设置、权限验证等服务
- **订单领域**: 提供订单状态变更事件，触发相关的消息通知
- **营销领域**: 提供营销活动信息，触发促销和活动相关的消息推送
- **支付领域**: 提供支付状态变更事件，触发支付相关的消息通知
- **物流领域**: 提供物流状态更新事件，触发发货和配送相关的消息通知

#### 2.4.2 下游领域

- **通知中心**: 接收消息推送结果，提供统一的通知管理界面
- **数据分析领域**: 接收消息推送数据，进行用户行为分析和效果评估
- **客服领域**: 接收用户反馈和投诉信息，处理消息相关的客服问题

### 2.5 领域模型

<!--@include: ./model.puml-->

### 2.6 领域事件

#### 2.6.1 核心事件

- **MessageCreated**: 消息创建事件，包含消息基本信息和推送配置
- **MessageSent**: 消息发送事件，标记消息已进入推送队列
- **MessagePushed**: 消息推送事件，记录具体渠道的推送结果
- **MessageRead**: 消息阅读事件，用户查看消息后触发
- **MessageArchived**: 消息归档事件，消息被用户或系统归档时触发

#### 2.6.2 事件处理

- **推送状态更新**: 监听推送事件，更新消息和推送日志的状态信息
- **用户行为统计**: 监听阅读和归档事件，统计用户的消息处理行为
- **推送效果分析**: 监听所有消息事件，分析推送渠道的效果和用户偏好

## 3. 战略设计

### 3.1 子域划分

#### 3.1.1 核心子域

- **消息管理子域**: 负责消息的创建、存储、查询和生命周期管理，是消息领域的核心业务
- **推送调度子域**: 负责多渠道推送的调度和状态管理，直接影响用户体验和业务效果

#### 3.1.2 支撑子域

- **模板管理子域**: 提供消息模板的管理和渲染服务，支撑消息内容的标准化
- **规则引擎子域**: 提供推送规则的配置和执行服务，支撑智能化推送策略
- **监控统计子域**: 提供消息推送的监控和统计服务，支撑运营决策和系统优化

#### 3.1.3 通用子域

- **应用管理子域**: 提供消息应用的注册和配置管理，属于平台通用功能
- **分类管理子域**: 提供消息分类的层级管理，属于内容管理通用功能

### 3.2 限界上下文

#### 3.2.1 消息管理上下文

**职责边界**: 负责消息实体的完整生命周期管理，包括创建、存储、查询、更新、归档等操作
**核心概念**: 消息、消息应用、消息分类、消息状态、消息数据
**业务规则**: 消息一致性规则、状态转换规则、权限控制规则

#### 3.2.2 推送调度上下文

**职责边界**: 负责消息的多渠道推送调度，包括渠道选择、推送执行、状态跟踪、失败重试
**核心概念**: 推送渠道、推送任务、推送状态、推送配置、推送日志
**业务规则**: 推送优先级规则、重试策略规则、频率控制规则

#### 3.2.3 模板管理上下文

**职责边界**: 负责消息模板的管理和内容渲染，包括模板创建、编辑、版本管理、变量替换
**核心概念**: 消息模板、模板变量、模板版本、渲染引擎
**业务规则**: 模板格式规则、变量验证规则、版本兼容性规则

### 3.3 上下文映射

#### 3.3.1 消息管理 ↔ 推送调度

**映射关系**: 共享内核关系，消息实体在两个上下文中共享
**协作方式**: 消息管理上下文创建消息后，推送调度上下文负责消息的推送执行
**数据一致性**: 通过领域事件保证消息状态在两个上下文中的一致性

#### 3.3.2 消息管理 ↔ 模板管理

**映射关系**: 客户-供应商关系，消息管理上下文是客户，模板管理上下文是供应商
**协作方式**: 消息管理上下文调用模板管理上下文的服务进行内容渲染
**接口定义**: 模板渲染接口、模板验证接口、模板查询接口

#### 3.3.3 推送调度 ↔ 外部推送服务

**映射关系**: 开放主机服务关系，推送调度上下文为外部推送服务提供统一接口
**协作方式**: 推送调度上下文通过适配器模式集成多个外部推送服务
**防腐层**: 实现防腐层隔离外部服务的复杂性和变化性

## 4. 战术设计

### 4.1 聚合设计

#### 4.1.1 消息聚合 (Message Aggregate)

**聚合根**: 消息 (Message)
**包含实体**: 无
**包含值对象**: 消息内容 (MessageContent)、推送配置 (PushConfig)、消息数据 (MessageData)
**一致性边界**: 保证消息状态变更的原子性，确保消息内容和推送状态的一致性
**核心业务规则**:
- 消息一旦创建，标题和内容不可修改
- 消息状态只能按照预定义的流程进行转换
- 阅后即焚消息在阅读后必须立即删除
- 过期消息不允许被阅读

#### 4.1.2 消息应用聚合 (MessageApp Aggregate)

**聚合根**: 消息应用 (MessageApp)
**包含实体**: 消息分类 (MessageCategory)
**包含值对象**: 应用配置 (AppConfig)
**一致性边界**: 保证应用配置和分类设置的一致性
**核心业务规则**:
- 应用名称在同一所有者下必须唯一
- 禁用状态的应用不能发送消息
- 应用删除时需要检查是否存在关联的消息

#### 4.1.3 消息模板聚合 (MessageTemplate Aggregate)

**聚合根**: 消息模板 (MessageTemplate)
**包含实体**: 无
**包含值对象**: 模板变量 (TemplateVariable)
**一致性边界**: 保证模板内容和变量定义的一致性
**核心业务规则**:
- 模板名称必须全局唯一
- 模板中使用的变量必须在变量定义中声明
- 禁用状态的模板不能用于创建消息

#### 4.1.4 推送日志聚合 (MessagePushLog Aggregate)

**聚合根**: 推送日志 (MessagePushLog)
**包含实体**: 无
**包含值对象**: 推送结果 (PushResult)、错误信息 (ErrorInfo)
**一致性边界**: 保证推送记录的完整性和准确性
**核心业务规则**:
- 推送日志只能新增，不允许修改或删除
- 推送失败时必须记录详细的错误信息
- 重试次数不能超过系统配置的最大值

### 4.2 实体设计

#### 4.2.1 消息 (Message) - 聚合根

**功能描述**: 消息系统的核心实体，承载完整的消息信息和状态管理
**核心职责**:
- 消息内容管理和状态控制
- 推送渠道配置和执行跟踪
- 业务规则验证和生命周期管理

#### 4.2.2 消息应用 (MessageApp) - 聚合根

**功能描述**: 消息发送应用的抽象，代表不同的业务系统或模块
**核心职责**:
- 应用身份管理和权限控制
- 推送配置管理和渠道设置
- 消息分类组织和业务隔离

#### 4.2.3 消息分类 (MessageCategory) - 实体

**功能描述**: 消息的分类管理，提供消息的组织和展示结构
**核心职责**:
- 分类层级管理和展示配置
- 业务线隔离和权限控制
- 用户界面定制和个性化设置

#### 4.2.4 消息模板 (MessageTemplate) - 聚合根

**功能描述**: 消息内容的模板化管理，支持变量替换和内容标准化
**核心职责**:
- 模板内容管理和版本控制
- 变量定义和替换规则管理
- 模板渲染和内容生成

#### 4.2.5 推送日志 (MessagePushLog) - 聚合根

**功能描述**: 消息推送过程的详细记录，用于状态跟踪和问题排查
**核心职责**:
- 推送过程记录和状态跟踪
- 错误信息收集和分析支持
- 重试机制控制和统计分析

### 4.3 值对象设计

#### 4.3.1 消息内容 (MessageContent)

**功能描述**: 封装消息的标题和正文内容，保证内容的完整性和不可变性
**核心属性**: 标题、正文内容、内容类型、附件信息

#### 4.3.2 推送配置 (PushConfig)

**功能描述**: 封装消息的推送渠道配置和推送参数
**核心属性**: 推送渠道列表、优先级设置、推送参数、重试配置

#### 4.3.3 消息数据 (MessageData)

**功能描述**: 封装消息的业务数据和模板变量值
**核心属性**: 业务数据字典、模板变量映射、扩展属性

#### 4.3.4 应用配置 (AppConfig)

**功能描述**: 封装消息应用的配置信息和推送设置
**核心属性**: 推送渠道配置、频率限制设置、权限配置、扩展配置

#### 4.3.5 模板变量 (TemplateVariable)

**功能描述**: 封装模板变量的定义和验证规则
**核心属性**: 变量名称、变量类型、默认值、验证规则、描述信息

### 4.4 领域服务

#### 4.4.1 消息发送服务 (MessageSendService)

**功能描述**: 处理消息的创建和发送逻辑，协调多个聚合的交互
**核心方法**: send()、batchSend()、validateSendPermission()

#### 4.4.2 消息推送服务 (MessagePushService)

**功能描述**: 处理消息的多渠道推送调度，管理推送状态和重试机制
**核心方法**: push()、pushToChannel()、retryPush()、logPushResult()

#### 4.4.3 消息模板服务 (MessageTemplateService)

**功能描述**: 处理消息模板的渲染和变量替换逻辑
**核心方法**: process()、renderTemplate()、validateTemplate()

#### 4.4.4 消息规则服务 (MessageRuleService)

**功能描述**: 处理消息推送规则的验证和执行
**核心方法**: validatePushRules()、checkFrequencyLimit()、selectOptimalChannel()

### 4.5 业务规则设计

#### 4.5.1 核心业务规则

- **消息不可变规则**: 消息一旦创建，核心内容（标题、正文）不允许修改，确保消息的完整性和可追溯性
- **状态转换规则**: 消息状态只能按照预定义的流程进行转换（未读→已读→归档），不允许逆向转换
- **权限访问规则**: 用户只能访问发送给自己的消息，管理员可以访问其管理范围内的所有消息
- **阅后即焚规则**: 标记为阅后即焚的消息在用户阅读后必须立即从系统中删除

#### 4.5.2 验证规则

- **消息内容验证**: 消息标题不能为空且长度不超过255字符，消息正文不能为空
- **推送渠道验证**: 推送渠道配置必须包含至少一个有效的推送方式
- **模板变量验证**: 使用模板时，所有模板变量必须提供有效值
- **应用权限验证**: 只有启用状态的应用才能发送消息，禁用应用的消息发送请求将被拒绝

#### 4.5.3 业务约束

- **消息频率约束**: 同一用户在单位时间内接收的消息数量不能超过系统配置的阈值
- **推送时间约束**: 非紧急消息不能在用户设定的免打扰时间内推送
- **存储时间约束**: 普通消息的存储时间不超过1年，过期消息自动归档或删除
- **并发处理约束**: 同一用户的消息操作需要进行并发控制，避免状态不一致

### 4.6 仓库接口

#### 4.6.1 消息仓库接口 (MessageRepositoryInterface)

**持久化职责**: 消息实体的持久化存储和基本查询操作
**核心方法**: store()、update()、delete()、find()、findByReceiver()、markAsRead()

#### 4.6.2 消息只读仓库接口 (MessageReadRepositoryInterface)

**检索职责**: 消息的复杂查询和统计分析操作
**核心方法**: paginate()、findList()、getUnreadCount()、getStatistics()

#### 4.6.3 消息应用仓库接口 (MessageAppRepositoryInterface)

**持久化职责**: 消息应用实体的持久化存储和管理操作
**核心方法**: store()、update()、delete()、find()、findByOwner()

#### 4.6.4 消息模板仓库接口 (MessageTemplateRepositoryInterface)

**持久化职责**: 消息模板实体的持久化存储和版本管理
**核心方法**: store()、update()、delete()、find()、findByName()、findActive()

### 4.7 工厂模式

#### 4.7.1 消息工厂 (MessageFactory)

**创建职责**: 负责复杂消息对象的创建，处理模板渲染和数据转换
**核心方法**: createFromTemplate()、createFromCommand()、createBatch()

#### 4.7.2 推送任务工厂 (PushTaskFactory)

**创建职责**: 负责推送任务对象的创建，处理渠道配置和参数设置
**核心方法**: createPushTask()、createBatchPushTask()、createRetryTask()

### 4.8 业务异常分类

#### 4.8.1 验证异常

- **MessageValidationException**: 消息内容验证失败
- **TemplateValidationException**: 模板格式或变量验证失败
- **PermissionValidationException**: 权限验证失败

#### 4.8.2 业务异常

- **MessageNotFoundException**: 消息不存在
- **MessageAccessDeniedException**: 消息访问权限不足
- **MessageExpiredException**: 消息已过期
- **FrequencyLimitExceededException**: 消息发送频率超限

#### 4.8.3 系统异常

- **MessageStorageException**: 消息存储失败
- **TemplateRenderException**: 模板渲染失败
- **PushServiceException**: 推送服务异常

#### 4.8.4 外部异常

- **ThirdPartyPushException**: 第三方推送服务异常
- **NetworkException**: 网络连接异常
- **ServiceUnavailableException**: 外部服务不可用

## 5. 应用层设计

### 5.1 应用服务

#### 5.1.1 消息应用服务 (MessageApplicationService)

**功能描述**: 消息领域的核心应用服务，提供消息的完整生命周期管理
**核心方法**:
- send(): 发送单条消息
- batchSend(): 批量发送消息  
- read(): 标记消息为已读
- batchRead(): 批量标记消息为已读
- archive(): 归档消息
- find(): 查找消息
- paginate(): 分页查询消息

#### 5.1.2 消息应用管理服务 (MessageAppApplicationService)

**功能描述**: 消息应用的管理服务，负责应用的注册、配置和权限管理
**核心方法**:
- create(): 创建消息应用
- update(): 更新应用配置
- enable(): 启用应用
- disable(): 禁用应用
- delete(): 删除应用

#### 5.1.3 消息模板应用服务 (MessageTemplateApplicationService)

**功能描述**: 消息模板的管理服务，负责模板的创建、编辑和渲染
**核心方法**:
- create(): 创建消息模板
- update(): 更新模板内容
- render(): 渲染模板内容
- validate(): 验证模板格式
- enable(): 启用模板
- disable(): 禁用模板

### 5.2 命令设计

#### 5.2.1 基础命令

- **MessageCreateCommand**: 创建消息命令，包含消息的基本信息和推送配置
- **MessageUpdateCommand**: 更新消息命令，主要用于状态变更
- **MessageDeleteCommand**: 删除消息命令，支持软删除和硬删除

#### 5.2.2 业务命令

- **MessageSendCommand**: 发送消息命令，包含完整的消息发送信息
- **MessageBatchSendCommand**: 批量发送消息命令，支持群发和定向发送
- **MessageReadCommand**: 消息阅读命令，记录用户的阅读行为
- **MessageBatchReadCommand**: 批量阅读命令，支持一键已读功能
- **MessageArchiveCommand**: 消息归档命令，用于消息的生命周期管理

### 5.3 查询设计

#### 5.3.1 基础查询

- **MessageFindQuery**: 单条消息查询，根据ID或其他唯一标识查找
- **MessageListQuery**: 消息列表查询，支持基本的分页和排序

#### 5.3.2 业务查询

- **MessagePaginateQuery**: 消息分页查询，支持复杂的过滤和搜索条件
- **MessageStatisticsQuery**: 消息统计查询，用于数据分析和报表生成
- **MessageUnreadCountQuery**: 未读消息数量查询，用于界面显示

### 5.4 命令处理器

#### 5.4.1 基础处理器

- **MessageCreateCommandHandler**: 消息创建处理器，处理消息的基本创建逻辑
- **MessageUpdateCommandHandler**: 消息更新处理器，处理消息状态的变更
- **MessageDeleteCommandHandler**: 消息删除处理器，处理消息的删除逻辑

#### 5.4.2 业务处理器

- **MessageSendCommandHandler**: 消息发送处理器，协调消息创建和推送流程
- **MessageBatchSendCommandHandler**: 批量发送处理器，处理大批量消息的发送
- **MessageReadCommandHandler**: 消息阅读处理器，处理用户的阅读行为和状态更新
- **MessageBatchReadCommandHandler**: 批量阅读处理器，处理批量标记已读的逻辑
- **MessageArchiveCommandHandler**: 消息归档处理器，处理消息的归档和清理

### 5.5 查询处理器

#### 5.5.1 基础处理器

- **MessageFindQueryHandler**: 单条消息查询处理器，处理精确查找逻辑
- **MessageListQueryHandler**: 消息列表查询处理器，处理基本的列表查询

#### 5.5.2 业务处理器

- **MessagePaginateQueryHandler**: 分页查询处理器，处理复杂的分页和过滤逻辑
- **MessageStatisticsQueryHandler**: 统计查询处理器，处理数据统计和分析逻辑
- **MessageUnreadCountQueryHandler**: 未读数量查询处理器，处理未读消息计数

### 5.6 转换器

#### 5.6.1 消息转换器 (MessageTransformer)

**数据映射职责**: 负责将命令数据转换为消息实体，处理数据格式转换和验证
**核心方法**: transform()、validateData()、mapProperties()

#### 5.6.2 消息应用转换器 (MessageAppTransformer)

**数据映射职责**: 负责将应用命令数据转换为应用实体
**核心方法**: transform()、validateConfig()、mapConfiguration()

#### 5.6.3 消息模板转换器 (MessageTemplateTransformer)

**数据映射职责**: 负责将模板命令数据转换为模板实体
**核心方法**: transform()、validateTemplate()、mapVariables()

## 6. 基础设施层设计

### 6.1 仓库实现

#### 6.1.1 消息写操作仓库 (MessageRepository)

**功能描述**: 消息实体的持久化存储和基本写操作
**核心方法**:
- store(): 存储消息实体
- update(): 更新消息信息
- delete(): 删除消息（软删除）
- findByReceiver(): 根据接收人查找消息
- markAsRead(): 批量标记消息为已读

#### 6.1.2 消息只读仓库 (MessageReadRepository)

**功能描述**: 消息的复杂查询和统计分析操作
**核心方法**:
- paginate(): 分页查询消息
- findList(): 根据ID列表查找消息
- getUnreadCount(): 获取未读消息数量
- getStatistics(): 获取消息统计数据
- searchMessages(): 全文搜索消息

### 6.2 过滤器配置

#### 6.2.1 允许的过滤器

- **精确匹配过滤器**: app_id、biz、category_id、receiver_id、sender_id、status、type、priority、is_urgent
- **部分匹配过滤器**: title、content（支持模糊搜索）
- **范围过滤器**: created_between、read_between（时间范围查询）
- **回调过滤器**: 自定义复杂查询条件

#### 6.2.2 允许的排序

- **基础排序**: id、created_at、read_at、updated_at
- **业务排序**: priority（优先级排序）、status（状态排序）
- **自定义排序**: 支持多字段组合排序

#### 6.2.3 允许的关联

- **基础关联**: app（消息应用）、category（消息分类）、template（消息模板）
- **用户关联**: sender（发送人）、receiver（接收人）
- **扩展关联**: pushLogs（推送日志）

## 7. 用户接口层设计

### 7.1 控制器

#### 7.1.1 消息控制器 (MessageController)

**功能描述**: 提供消息的RESTful API接口，支持消息的查询、发送、阅读等操作
**核心接口**:
- index(): 获取消息列表（支持分页和过滤）
- show(): 获取单条消息详情
- store(): 发送新消息
- update(): 更新消息状态
- destroy(): 删除消息
- markAsRead(): 标记消息为已读
- batchRead(): 批量标记已读
- unreadCount(): 获取未读消息数量

#### 7.1.2 消息应用控制器 (MessageAppController)

**功能描述**: 提供消息应用的管理接口，支持应用的创建、配置和权限管理
**核心接口**:
- index(): 获取应用列表
- show(): 获取应用详情
- store(): 创建新应用
- update(): 更新应用配置
- destroy(): 删除应用

#### 7.1.3 消息模板控制器 (MessageTemplateController)

**功能描述**: 提供消息模板的管理接口，支持模板的创建、编辑和预览
**核心接口**:
- index(): 获取模板列表
- show(): 获取模板详情
- store(): 创建新模板
- update(): 更新模板内容
- destroy(): 删除模板
- preview(): 预览模板渲染效果

### 7.2 API资源

#### 7.2.1 消息资源 (MessageResource)

**功能描述**: 消息数据的API资源转换，控制返回给客户端的数据格式
**核心字段**:
- 基础信息: id、title、content、type、priority、status
- 时间信息: created_at、updated_at、read_at、expires_at
- 关联信息: app、category、sender、template
- 配置信息: channels、is_urgent、is_burn_after_read

#### 7.2.2 消息应用资源 (MessageAppResource)

**功能描述**: 消息应用数据的API资源转换
**核心字段**:
- 基础信息: id、name、description、icon、status
- 配置信息: config（推送配置、权限设置等）
- 关联信息: categories（消息分类列表）

#### 7.2.3 消息模板资源 (MessageTemplateResource)

**功能描述**: 消息模板数据的API资源转换
**核心字段**:
- 基础信息: id、name、title_template、content_template、status
- 变量信息: variables（模板变量定义）

### 7.3 请求验证

#### 7.3.1 消息发送请求验证 (MessageSendRequest)

**验证规则**:
- 必填字段: app_id、biz、receiver_id、title、content
- 字段格式: title最大255字符、content不能为空
- 业务验证: app_id必须存在且启用、receiver_id必须有效
- 推送配置: channels数组验证、expires_at时间验证

#### 7.3.2 消息应用请求验证 (MessageAppRequest)

**验证规则**:
- 必填字段: name
- 唯一性验证: name在同一owner下唯一
- 配置验证: config格式验证

#### 7.3.3 消息模板请求验证 (MessageTemplateRequest)

**验证规则**:
- 必填字段: name、title_template、content_template
- 唯一性验证: name全局唯一
- 模板验证: 变量格式验证、模板语法验证

### 7.4 路由定义

#### 7.4.1 用户端API路由

- **消息管理**: GET/POST/PUT/DELETE /api/messages
- **消息操作**: PATCH /api/messages/{id}/read, PATCH /api/messages/batch-read
- **未读统计**: GET /api/messages/unread-count

#### 7.4.2 管理端API路由

- **应用管理**: GET/POST/PUT/DELETE /api/admin/message-apps
- **模板管理**: GET/POST/PUT/DELETE /api/admin/message-templates
- **分类管理**: GET/POST/PUT/DELETE /api/admin/message-categories

## 8. 数据模型设计

### 8.1 核心数据表

#### 8.1.1 消息表 (messages)

**表说明**: 存储消息的完整信息，是消息系统的核心数据表
**核心字段**:
- 基础字段: id、app_id、biz、category_id、receiver_id、sender_id
- 内容字段: title、content、data（JSON）
- 状态字段: status、read_at、push_status
- 配置字段: channels（JSON）、is_urgent、is_burn_after_read、expires_at
- 时间字段: created_at、updated_at

**索引设计**:
- 主键索引: id
- 业务索引: receiver_id + status + created_at（用户消息查询）
- 复合索引: app_id + biz + created_at（应用消息统计）
- 状态索引: push_status + created_at（推送状态查询）

#### 8.1.2 消息应用表 (message_apps)

**表说明**: 存储消息应用的配置信息
**核心字段**:
- 基础字段: id、name、description、icon、owner_id
- 状态字段: status
- 配置字段: config（JSON，包含推送配置等）
- 时间字段: created_at、updated_at

**索引设计**:
- 主键索引: id
- 唯一索引: owner_id + name（同一所有者下应用名唯一）
- 状态索引: status

#### 8.1.3 消息模板表 (message_templates)

**表说明**: 存储消息模板的定义和变量配置
**核心字段**:
- 基础字段: id、name、title_template、content_template
- 变量字段: variables（JSON，模板变量定义）
- 状态字段: status
- 时间字段: created_at、updated_at

**索引设计**:
- 主键索引: id
- 唯一索引: name（模板名全局唯一）
- 状态索引: status

#### 8.1.4 推送日志表 (message_push_logs)

**表说明**: 记录消息推送的详细日志，用于状态跟踪和问题排查
**核心字段**:
- 关联字段: message_id、channel
- 状态字段: status、pushed_at、error_message
- 重试字段: retry_count
- 时间字段: created_at

**索引设计**:
- 主键索引: id
- 外键索引: message_id
- 复合索引: channel + status + created_at（渠道推送统计）

### 8.2 数据关系图

<!--@include: ./database-relation.puml-->

### 8.3 数据迁移策略

#### 8.3.1 版本管理

- **迁移文件命名**: 使用时间戳+描述的格式，确保迁移顺序
- **向前兼容**: 新版本迁移必须兼容旧版本数据结构
- **回滚支持**: 每个迁移都必须提供对应的回滚脚本

#### 8.3.2 向后兼容

- **字段添加**: 新增字段必须设置默认值或允许NULL
- **字段修改**: 避免直接修改字段类型，采用新增+数据迁移+删除旧字段的方式
- **索引变更**: 新增索引在业务低峰期执行，删除索引需要确认无业务影响

#### 8.3.3 数据备份

- **迁移前备份**: 执行重要迁移前必须进行全量数据备份
- **增量备份**: 建立定期的增量备份机制
- **备份验证**: 定期验证备份数据的完整性和可恢复性

#### 8.3.4 回滚策略

- **快速回滚**: 对于可逆操作，提供快速回滚脚本
- **数据回滚**: 对于数据变更，准备数据回滚方案
- **服务回滚**: 配合应用版本回滚，确保数据结构兼容性

## 9. 核心用例

### 9.1 UC001 - 发送消息用例

**参与者**: 业务应用、消息系统、推送服务
**前置条件**: 
- 消息应用已注册并启用
- 接收用户存在且有效
- 推送渠道配置正确

**主流程**:
1. 业务应用调用消息发送接口，传入消息内容和推送配置
2. 消息系统验证应用权限和消息内容格式
3. 如果使用模板，系统进行模板渲染和变量替换
4. 系统创建消息实体并存储到数据库
5. 系统根据推送配置创建推送任务
6. 推送服务执行多渠道推送并记录推送状态
7. 系统更新消息的推送状态
8. 返回消息发送成功响应

**后置条件**: 
- 消息已创建并存储
- 推送任务已执行
- 推送日志已记录

### 9.2 UC002 - 用户阅读消息用例

**参与者**: 用户、消息系统
**前置条件**:
- 用户已登录系统
- 存在发送给该用户的未读消息
- 用户有权限访问该消息

**主流程**:
1. 用户请求查看消息详情
2. 系统验证用户身份和访问权限
3. 系统检查消息是否已过期
4. 系统返回消息详情内容
5. 系统将消息状态更新为已读
6. 系统记录消息阅读时间
7. 如果是阅后即焚消息，系统删除消息记录
8. 系统发布消息已读事件

**后置条件**:
- 消息状态已更新为已读
- 阅读时间已记录
- 阅后即焚消息已删除（如适用）

### 9.3 UC003 - 批量推送营销消息用例

**参与者**: 运营人员、消息系统、推送服务、目标用户群
**前置条件**:
- 运营人员有发送营销消息的权限
- 目标用户群已确定
- 消息模板已准备就绪
- 推送渠道配置正确

**主流程**:
1. 运营人员选择目标用户群和消息模板
2. 系统验证用户权限和模板有效性
3. 系统根据用户群生成批量推送任务
4. 系统对每个用户进行频率限制检查
5. 系统批量创建消息实体并存储
6. 系统将推送任务加入消息队列
7. 推送服务异步处理推送任务
8. 系统记录每个用户的推送结果
9. 系统生成推送统计报告

**后置条件**:
- 批量消息已创建
- 推送任务已执行
- 推送统计已生成

## 10. 统一语言表

| 英文名称 | 中文名称 | 说明 | 示例 |
|---------|---------|-----|------|
| Message | 消息 | 系统中传递信息的基本单元 | 订单支付成功通知 |
| MessageApp | 消息应用 | 发送消息的业务应用系统 | 订单系统、营销系统 |
| MessageCategory | 消息分类 | 消息的分类管理标识 | 订单通知、营销推广 |
| MessageTemplate | 消息模板 | 标准化的消息内容模板 | 订单支付模板 |
| MessageContent | 消息内容 | 消息的标题和正文内容 | 标题：订单支付成功 |
| PushConfig | 推送配置 | 消息的推送渠道和参数配置 | APP推送+短信通知 |
| MessageData | 消息数据 | 消息的业务数据和变量值 | 订单号、金额等数据 |
| AppConfig | 应用配置 | 消息应用的配置信息 | 推送渠道、频率限制 |
| TemplateVariable | 模板变量 | 模板中的变量定义和规则 | {{orderNo}}、{{amount}} |
| PushChannel | 推送渠道 | 消息推送的具体渠道 | APP内消息、邮件、短信 |
| PushTask | 推送任务 | 具体的推送执行任务 | 向用户A推送订单通知 |
| PushLog | 推送日志 | 推送过程的详细记录 | 推送时间、状态、错误信息 |
| MessageStatus | 消息状态 | 消息的当前状态 | 未读、已读、已归档 |
| PushStatus | 推送状态 | 推送任务的执行状态 | 等待中、已发送、失败 |
| BizLine | 业务线 | 消息所属的业务领域 | 用户端、商家端、管理端 |
| MessageType | 消息类型 | 消息的业务类型分类 | 通知、警告、提醒 |
| Priority | 优先级 | 消息的重要程度等级 | 低、普通、高、紧急 |
| Receiver | 接收人 | 消息的接收用户 | 用户ID、商家ID |
| Sender | 发送人 | 消息的发送者 | 系统、管理员、用户 |
| MessageSource | 消息来源 | 消息的创建来源 | 系统自动、用户手动、API调用 |
| FrequencyLimit | 频率限制 | 消息发送的频率控制 | 每小时最多5条消息 |
| BurnAfterRead | 阅后即焚 | 阅读后立即删除的消息属性 | 敏感信息通知 |
| UrgentMessage | 强提醒消息 | 需要强制提醒的重要消息 | 安全警告、紧急通知 |
| MessageExpiry | 消息过期 | 消息的有效期限制 | 24小时后过期 |
| TemplateRender | 模板渲染 | 将模板转换为具体消息内容 | 替换变量生成最终内容 |
| MessageQueue | 消息队列 | 异步处理消息推送的队列 | Redis队列、数据库队列 |
| PushRetry | 推送重试 | 推送失败后的重试机制 | 最多重试3次 |
| MessageArchive | 消息归档 | 消息的归档和清理管理 | 过期消息自动归档 |
| UnreadCount | 未读数量 | 用户未读消息的统计数量 | 用户有5条未读消息 |
| PushStatistics | 推送统计 | 消息推送效果的统计分析 | 推送成功率、阅读率 |
| MessageRule | 消息规则 | 消息发送和推送的业务规则 | 免打扰时间、用户偏好 |

## 11. 附录

### 11.1 术语表

| 术语 | 定义 | 说明 |
|-----|------|-----|
| DDD | 领域驱动设计 | Domain-Driven Design，一种软件开发方法论 |
| CQRS | 命令查询职责分离 | Command Query Responsibility Segregation |
| 聚合根 | 聚合的根实体 | 负责维护聚合内部的一致性 |
| 值对象 | 不可变的对象 | 通过属性值来标识，而不是通过ID |
| 领域事件 | 领域中发生的事件 | 用于解耦和异步处理 |
| 防腐层 | 隔离外部系统的层 | Anti-Corruption Layer |

### 11.2 参考资料

- 《领域驱动设计》- Eric Evans
- 《实现领域驱动设计》- Vaughn Vernon
- 《微服务架构设计模式》- Chris Richardson
- Laravel 官方文档
- Red Jasmine Framework 架构指南

### 11.3 变更记录

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|---------|--------|
| 1.0 | 2024-01-15 | 初始版本创建 | 开发团队 |
| 1.1 | 2024-01-20 | 添加推送渠道设计 | 开发团队 |
| 1.2 | 2024-01-25 | 完善业务规则和异常处理 | 开发团队 |
