---
title: 优惠券领域核心规则
description: 优惠券领域的业务规则和验证逻辑
outline: deep
order: 4
lastUpdated: true
tags: [优惠券, 业务规则, 验证逻辑]
author: Red Jasmine Team
---

# 优惠券领域核心规则

## 概述

本文档详细说明优惠券领域的核心业务规则和验证逻辑，包括优惠券创建、发放、使用、核销等各个环节的规则约束，确保优惠券系统的业务逻辑正确性和数据一致性。

## 业务规则

### 1. 优惠券创建规则

#### 1.1 基本信息规则
- **名称唯一性**：同一所有者下的优惠券名称必须唯一
- **描述完整性**：优惠券描述不能为空，且长度不超过500字符
- **类型选择**：优惠券类型必须为折扣券、满减券或包邮券
- **成本承担方**：每个优惠券必须指定唯一的成本承担方

#### 1.2 配置规则
- **门槛金额**：使用门槛金额必须大于等于0
- **优惠金额**：满减券的优惠金额必须大于0且小于等于门槛金额
- **折扣比例**：折扣券的折扣比例必须在0.01-0.99之间
- **有效期设置**：绝对时间的结束时间必须大于开始时间，相对时间的天数必须大于0

#### 1.3 发放策略规则
- **发放数量**：总发放数量必须大于0
- **限制设置**：每日限量不能超过总发放数量
- **个人限领**：个人限领数量不能超过总发放数量
- **时间范围**：发放时间范围必须在优惠券有效期内

### 2. 优惠券发放规则

#### 2.1 数量限制规则
- **总量控制**：已发放数量不能超过总发放数量
- **每日限量**：当日发放数量不能超过每日限量设置
- **个人限领**：单个用户领取数量不能超过个人限领设置
- **库存检查**：发放前必须检查剩余库存

#### 2.2 时间限制规则
- **发放时间**：只能在发放时间范围内进行发放
- **优惠券状态**：只有已发布状态的优惠券才能发放
- **过期检查**：不能发放已过期的优惠券

#### 2.3 用户资格规则
- **新用户限制**：新用户券只能发放给注册时间在指定范围内的用户
- **会员限制**：会员券只能发放给达到指定等级的会员用户
- **指定用户**：指定用户券只能发放给白名单中的用户
- **消费门槛**：有消费门槛的优惠券只能发放给满足条件的用户

### 3. 优惠券使用规则

#### 3.1 基本使用规则
- **状态检查**：只有未使用状态的优惠券才能使用
- **有效期验证**：优惠券必须在有效期内使用
- **用户匹配**：优惠券只能由领取用户本人使用
- **单次使用**：每张优惠券只能使用一次

#### 3.2 订单匹配规则
- **金额门槛**：订单金额必须满足优惠券的使用门槛
- **商品限制**：订单商品必须符合优惠券的商品限制条件
- **类目限制**：订单商品类目必须符合优惠券的类目限制
- **排除规则**：订单不能包含被排除的商品或类目

#### 3.3 叠加使用规则
- **禁止叠加**：设置为禁止叠加的优惠券不能与其他优惠券同时使用
- **限制叠加**：设置为限制叠加的优惠券只能与指定类型的优惠券叠加
- **允许叠加**：设置为允许叠加的优惠券可以与其他优惠券同时使用
- **优先级规则**：多张优惠券叠加时按优先级顺序计算优惠

### 4. 优惠券核销规则

#### 4.1 核销条件
- **订单状态**：只有已支付的订单才能进行优惠券核销
- **使用记录**：必须存在对应的优惠券使用记录
- **时间限制**：核销必须在使用后的指定时间内完成
- **金额匹配**：核销金额必须与使用记录中的优惠金额一致

#### 4.2 核销流程
- **状态更新**：核销成功后更新优惠券使用记录状态
- **统计更新**：更新优惠券的使用统计数据
- **成本结算**：根据成本承担方进行成本结算

### 5. 优惠券退款规则

#### 5.1 退款条件
- **订单退款**：只有在订单退款时才能进行优惠券退款
- **使用状态**：只有已使用的优惠券才能退款
- **时间限制**：退款必须在指定时间内完成
- **部分退款**：支持按退款商品比例进行部分退款

#### 5.2 退款处理
- **状态恢复**：退款后将优惠券状态恢复为未使用（如果在有效期内）
- **金额计算**：按退款比例计算退款金额
- **统计调整**：调整优惠券使用统计数据
- **成本调整**：调整成本结算金额

## 验证逻辑

### 1. 创建验证

#### 1.1 基础验证
- 验证优惠券名称的唯一性
- 验证优惠券类型的有效性
- 验证成本承担方的有效性
- 验证配置参数的合理性

#### 1.2 业务验证
- 验证发放策略的合理性
- 验证使用限制的有效性
- 验证时间配置的正确性
- 验证权限和授权

### 2. 发放验证

#### 2.1 数量验证
- 验证总发放数量限制
- 验证每日发放数量限制
- 验证个人领取数量限制
- 验证库存余量

#### 2.2 资格验证
- 验证用户是否符合发放条件
- 验证用户是否已达到领取上限
- 验证发放时间是否有效
- 验证优惠券状态是否可发放

### 3. 使用验证

#### 3.1 状态验证
- 验证优惠券状态是否为未使用
- 验证优惠券是否在有效期内
- 验证用户是否为优惠券持有者
- 验证优惠券是否已被冻结

#### 3.2 订单验证
- 验证订单金额是否满足使用门槛
- 验证订单商品是否符合使用限制
- 验证订单类目是否符合限制条件
- 验证优惠券叠加使用规则

### 4. 核销验证

#### 4.1 前置验证
- 验证订单是否已支付
- 验证优惠券使用记录是否存在
- 验证核销时间是否在有效期内
- 验证核销金额是否正确

#### 4.2 状态验证
- 验证优惠券使用记录状态
- 验证是否重复核销
- 验证核销权限
- 验证系统状态

### 5. 退款验证

#### 5.1 条件验证
- 验证订单退款状态
- 验证优惠券使用状态
- 验证退款时间限制
- 验证退款金额计算

#### 5.2 业务验证
- 验证退款比例的合理性
- 验证优惠券恢复条件
- 验证成本调整的准确性
- 验证统计数据的一致性

## 异常处理

### 1. 业务异常
- **库存不足**：发放时库存不足的处理
- **重复领取**：用户重复领取的处理
- **过期使用**：使用过期优惠券的处理
- **条件不符**：不符合使用条件的处理

### 2. 系统异常
- **并发冲突**：高并发场景下的数据一致性处理
- **网络异常**：网络中断时的事务处理
- **数据异常**：数据不一致时的修复处理
- **服务异常**：依赖服务异常时的降级处理

### 3. 补偿机制
- **事务补偿**：失败事务的补偿处理
- **数据修复**：异常数据的自动修复
- **状态同步**：状态不一致时的同步机制
- **告警通知**：异常情况的告警和通知

## 性能优化

### 1. 缓存策略
- **热点数据缓存**：缓存热门优惠券信息
- **用户券缓存**：缓存用户优惠券列表
- **计数器缓存**：缓存发放和使用计数器
- **配置缓存**：缓存优惠券配置信息

### 2. 查询优化
- **索引优化**：合理设计数据库索引
- **分页查询**：大数据量查询的分页处理
- **批量操作**：批量处理提高效率
- **异步处理**：非实时操作的异步处理

### 3. 并发控制
- **乐观锁**：使用乐观锁控制并发更新
- **分布式锁**：使用分布式锁控制关键操作
- **限流控制**：对高频操作进行限流
- **队列处理**：使用消息队列处理高并发请求

这些核心规则和验证逻辑确保了优惠券系统的业务正确性、数据一致性和系统稳定性，为电商平台提供可靠的优惠券服务。 