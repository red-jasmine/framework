---
title: 优惠券领域核心规则
description: 优惠券领域的业务规则、约束条件和验证逻辑说明
outline: deep
order: 3
lastUpdated: true
tags: [优惠券, 业务规则, 验证逻辑]
author: Red Jasmine Team
---

# 优惠券领域核心规则

## 概述

优惠券领域的核心规则定义了优惠券创建、发放、使用等各个环节的业务约束和验证逻辑。这些规则确保优惠券系统的正确性、公平性和安全性，为用户提供良好的使用体验。

## 优惠券创建规则

### 1. 基本信息验证规则

#### 1.1 名称和描述规则
- **名称长度**：优惠券名称长度必须在2-100个字符之间
- **描述长度**：优惠券描述长度不能超过1000个字符
- **特殊字符**：名称和描述不能包含特殊HTML标签和脚本
- **重复检查**：同一所有者下不能存在相同名称的优惠券

#### 1.2 类型和成本承担规则
- **类型选择**：优惠券类型必须为平台券、商家券或主播券
- **成本承担方**：每个优惠券必须指定唯一的成本承担方（平台、商家或主播）
- **单一承担方**：每个优惠券只能有一个成本承担方
- **权限控制**：只有商家可以创建商家券，只有主播可以创建主播券，平台可以创建平台券

### 2. 配置规则

#### 2.1 金额配置规则
- **使用门槛**：使用门槛金额必须大于0
- **优惠金额**：满减券的优惠金额必须大于0且小于等于使用门槛
- **折扣比例**：折扣券的折扣比例必须在0.1-0.99之间
- **最大优惠**：最大优惠金额不能超过订单金额的80%

#### 2.2 时间配置规则
- **有效期类型**：必须选择绝对时间或相对时间
- **绝对时间**：开始时间必须早于结束时间，结束时间不能早于当前时间
- **相对时间**：相对天数必须在1-365天之间
- **时间冲突**：发放时间和使用时间不能存在冲突

### 3. 发放策略规则

#### 3.1 数量控制规则
- **总发放数量**：总发放数量必须大于0
- **每日限量**：每日限量不能超过总发放数量
- **个人限领**：个人限领数量必须在1-10之间
- **发放时间**：发放开始时间不能晚于结束时间

#### 3.2 发放方式规则
- **自动发放**：自动发放需要配置触发条件
- **手动发放**：手动发放需要指定目标用户
- **活动发放**：活动发放需要关联营销活动

## 优惠券发放规则

### 1. 用户资格验证规则

#### 1.1 用户限制验证
- **新人券**：用户注册时间必须在指定范围内
- **会员券**：用户等级必须满足要求
- **指定用户**：用户ID必须在允许的用户列表中
- **消费限制**：用户历史消费金额必须满足要求

#### 1.2 重复领取检查
- **个人限领**：用户已领取数量不能超过个人限领数量
- **时间限制**：同一用户在同一时间段内不能重复领取
- **状态检查**：用户不能领取已停用或已删除的优惠券

### 2. 发放数量控制规则

#### 2.1 总量控制
- **剩余数量**：已发放数量不能超过总发放数量
- **原子操作**：发放操作必须是原子性的，防止超发
- **并发控制**：使用分布式锁防止并发发放超量

#### 2.2 每日限量控制
- **日发放量**：当日发放数量不能超过每日限量
- **时间重置**：每日凌晨重置发放计数器
- **缓存更新**：实时更新Redis中的发放计数器

### 3. 发放时间控制规则

#### 3.1 时间窗口验证
- **发放时间**：当前时间必须在发放时间窗口内
- **活动时间**：活动发放必须在活动有效期内
- **系统时间**：使用服务器时间，考虑时区问题

## 优惠券使用规则

### 1. 使用条件验证规则

#### 1.1 基础条件验证
- **优惠券状态**：优惠券必须是未使用状态
- **有效期检查**：当前时间必须在有效期内
- **用户匹配**：使用用户必须是优惠券的领取用户

#### 1.2 订单条件验证
- **订单金额**：订单金额必须满足使用门槛
- **商品限制**：订单商品必须在允许的商品范围内
- **排除商品**：订单不能包含排除的商品
- **类目限制**：订单商品类目必须在允许的类目范围内

### 2. 金额计算规则

#### 2.1 满减券计算
- **门槛验证**：订单金额必须大于等于使用门槛
- **优惠计算**：优惠金额 = min(优惠券金额, 订单金额 * 最大优惠比例)
- **最终金额**：实付金额 = 订单金额 - 优惠金额

#### 2.2 折扣券计算
- **折扣验证**：折扣比例必须在有效范围内
- **优惠计算**：优惠金额 = 订单金额 * (1 - 折扣比例)
- **最大限制**：优惠金额不能超过最大优惠金额

### 3. 叠加规则验证

#### 3.1 叠加类型
- **允许叠加**：可以与其他优惠券同时使用
- **禁止叠加**：不能与其他优惠券同时使用
- **限制叠加**：最多可以与指定数量的优惠券叠加

#### 3.2 叠加优先级
- **金额优先**：优先使用优惠金额较大的优惠券
- **类型优先**：满减券优先于折扣券
- **时间优先**：即将过期的优惠券优先使用

## 优惠券核销规则

### 1. 核销时机规则

#### 1.1 支付成功核销
- **支付确认**：只有在支付成功后才进行核销
- **状态更新**：核销后立即更新优惠券状态为已使用
- **记录创建**：创建使用记录，记录详细信息

#### 1.2 异常处理规则
- **支付失败**：支付失败时恢复优惠券状态
- **超时处理**：支付超时时自动释放优惠券
- **重复核销**：防止同一优惠券重复核销

### 2. 成本承担规则

#### 2.1 成本承担
- **平台券**：平台承担100%成本
- **商家券**：商家承担100%成本
- **主播券**：主播承担100%成本

#### 2.2 结算处理
- **实时结算**：核销时立即计算承担金额
- **批量结算**：定期批量处理成本结算
- **异常处理**：结算失败时记录异常日志

## 优惠券退款规则

### 1. 退款条件规则

#### 1.1 退款时机
- **订单取消**：订单取消时自动退款优惠券
- **部分退款**：部分退款时按比例处理优惠券
- **全额退款**：全额退款时恢复优惠券状态

#### 1.2 退款限制
- **过期优惠券**：已过期的优惠券不能退款
- **使用时间**：超过退款时间限制的不能退款
- **活动规则**：特殊活动的优惠券按活动规则处理

### 2. 退款处理规则

#### 2.1 状态恢复
- **状态更新**：退款后将优惠券状态恢复为未使用
- **时间延长**：根据退款时间适当延长有效期
- **记录更新**：更新使用记录，标记为已退款

#### 2.2 成本处理
- **成本回收**：回收已承担的成本
- **统计更新**：更新相关统计数据
- **通知发送**：发送退款通知给用户

## 数据统计规则

### 1. 统计指标计算

#### 1.1 基础指标
- **发放数量**：实际发放给用户的优惠券数量
- **使用数量**：实际使用的优惠券数量
- **使用率**：使用数量 / 发放数量
- **转化率**：使用优惠券的订单数 / 发放数量

#### 1.2 金额指标
- **总优惠金额**：所有使用优惠券的优惠金额总和
- **总成本金额**：平台和商家承担的成本总和
- **ROI**：总优惠金额 / 总成本金额

### 2. 统计更新规则

#### 2.1 实时更新
- **发放统计**：每次发放时实时更新发放数量
- **使用统计**：每次使用时实时更新使用数量
- **金额统计**：每次使用时实时更新金额统计

#### 2.2 定时更新
- **使用率计算**：每小时计算一次使用率
- **转化率计算**：每日计算一次转化率
- **ROI计算**：每日计算一次ROI

## 安全规则

### 1. 防刷规则

#### 1.1 领取限制
- **频率限制**：同一用户每分钟最多领取1张优惠券
- **IP限制**：同一IP每分钟最多领取5张优惠券
- **设备限制**：同一设备每小时最多领取10张优惠券

#### 1.2 使用限制
- **使用频率**：同一用户每分钟最多使用1张优惠券
- **异常检测**：检测异常使用行为并记录日志
- **黑名单**：对恶意用户进行黑名单处理

### 2. 数据安全规则

#### 2.1 数据加密
- **敏感信息**：用户ID、优惠券码等敏感信息进行加密存储
- **传输安全**：API接口使用HTTPS传输
- **访问控制**：严格控制数据库访问权限

#### 2.2 审计日志
- **操作记录**：记录所有优惠券相关操作
- **异常记录**：记录所有异常操作和错误
- **访问日志**：记录所有API访问日志

## 性能规则

### 1. 缓存策略

#### 1.1 缓存更新
- **写入更新**：数据写入时立即更新缓存
- **定时更新**：定时更新统计数据缓存
- **失效策略**：设置合理的缓存失效时间

#### 1.2 缓存穿透
- **空值缓存**：对空结果进行缓存，防止缓存穿透
- **布隆过滤器**：使用布隆过滤器快速判断数据是否存在
- **限流措施**：对高频查询进行限流

### 2. 数据库优化

#### 2.1 查询优化
- **索引使用**：合理使用索引提升查询性能
- **分页查询**：大数据量查询使用分页
- **读写分离**：查询操作使用从库

#### 2.2 写入优化
- **批量操作**：批量插入和更新提升性能
- **异步处理**：非关键操作使用异步处理
- **连接池**：合理配置数据库连接池

## 扩展规则

### 1. 插件化规则

#### 1.1 优惠券类型扩展
- **接口规范**：定义优惠券类型扩展接口
- **注册机制**：提供优惠券类型注册机制
- **配置管理**：支持动态配置优惠券类型

#### 1.2 验证规则扩展
- **验证接口**：定义验证规则扩展接口
- **规则链**：支持验证规则链式调用
- **优先级**：支持验证规则优先级设置

### 2. API接口规则

#### 2.1 接口规范
- **RESTful设计**：遵循RESTful API设计规范
- **版本控制**：支持API版本控制
- **文档生成**：自动生成API文档

#### 2.2 错误处理
- **错误码**：定义统一的错误码规范
- **错误信息**：提供详细的错误信息
- **重试机制**：支持接口重试机制

这些核心规则确保了优惠券系统的正确性、安全性和可扩展性，为电商平台提供可靠的优惠券服务。 