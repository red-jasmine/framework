@startuml
skinparam sequenceArrowThickness 2
skinparam roundcorner 20
skinparam maxmessagesize 60

title 优惠券领域核心业务流程时序图

actor 平台运营 as Platform
actor 用户 as User
actor 商家 as Merchant
participant 优惠券服务 as CouponService
participant 用户服务 as UserService
participant 商品服务 as ProductService
participant 订单服务 as OrderService
participant 支付服务 as PaymentService
participant 通知服务 as NotificationService
database 数据库 as DB
queue 消息队列 as MQ

== 优惠券创建流程 ==

Platform -> CouponService: 创建优惠券请求
activate CouponService

CouponService -> CouponService: 验证创建权限
CouponService -> CouponService: 验证优惠券配置
CouponService -> DB: 保存优惠券基本信息
activate DB
DB --> CouponService: 返回优惠券ID
deactivate DB

CouponService -> DB: 保存优惠券配置
CouponService -> DB: 保存发放策略
CouponService -> DB: 保存使用限制

CouponService -> MQ: 发送优惠券创建事件
activate MQ
MQ --> CouponService: 确认事件发送
deactivate MQ

CouponService --> Platform: 返回创建结果
deactivate CouponService

== 优惠券发放流程 ==

Platform -> CouponService: 发放优惠券请求
activate CouponService

CouponService -> DB: 查询优惠券信息
activate DB
DB --> CouponService: 返回优惠券数据
deactivate DB

CouponService -> CouponService: 验证发放条件
CouponService -> DB: 检查发放数量限制
activate DB
DB --> CouponService: 返回当前发放数量
deactivate DB

CouponService -> UserService: 获取目标用户列表
activate UserService
UserService --> CouponService: 返回用户列表
deactivate UserService

loop 为每个用户发放
    CouponService -> DB: 创建用户优惠券记录
    activate DB
    DB --> CouponService: 返回用户优惠券ID
    deactivate DB
    
    CouponService -> DB: 更新发放统计
    CouponService -> MQ: 发送优惠券发放事件
    activate MQ
    MQ --> CouponService: 确认事件发送
    deactivate MQ
end

CouponService -> NotificationService: 发送发放通知
activate NotificationService
NotificationService --> CouponService: 确认通知发送
deactivate NotificationService

CouponService --> Platform: 返回发放结果
deactivate CouponService

== 优惠券使用流程 ==

User -> OrderService: 创建订单并选择优惠券
activate OrderService

OrderService -> CouponService: 验证优惠券使用条件
activate CouponService

CouponService -> DB: 查询用户优惠券信息
activate DB
DB --> CouponService: 返回优惠券数据
deactivate DB

CouponService -> CouponService: 验证使用条件
CouponService -> ProductService: 验证商品限制
activate ProductService
ProductService --> CouponService: 返回商品验证结果
deactivate ProductService

CouponService -> CouponService: 计算优惠金额
CouponService -> DB: 锁定优惠券状态
activate DB
DB --> CouponService: 确认锁定
deactivate DB

CouponService --> OrderService: 返回验证结果和优惠金额
deactivate CouponService

OrderService -> OrderService: 计算最终订单金额
OrderService -> DB: 保存订单信息
activate DB
DB --> OrderService: 返回订单ID
deactivate DB

OrderService --> User: 返回订单创建结果
deactivate OrderService

== 优惠券核销流程 ==

User -> PaymentService: 支付订单
activate PaymentService

PaymentService -> PaymentService: 处理支付逻辑
PaymentService -> DB: 更新支付状态
activate DB
DB --> PaymentService: 确认支付成功
deactivate DB

PaymentService -> CouponService: 核销优惠券
activate CouponService

CouponService -> DB: 更新优惠券状态为已使用
activate DB
DB --> CouponService: 确认状态更新
deactivate DB

CouponService -> DB: 创建使用记录
activate DB
DB --> CouponService: 返回记录ID
deactivate DB

CouponService -> CouponService: 计算成本分摊
CouponService -> DB: 保存成本分摊记录
activate DB
DB --> CouponService: 确认保存
deactivate DB

CouponService -> DB: 更新统计数据
activate DB
DB --> CouponService: 确认更新
deactivate DB

CouponService -> MQ: 发送优惠券使用事件
activate MQ
MQ --> CouponService: 确认事件发送
deactivate MQ

CouponService -> NotificationService: 发送使用通知
activate NotificationService
NotificationService --> CouponService: 确认通知发送
deactivate NotificationService

CouponService --> PaymentService: 返回核销结果
deactivate CouponService

PaymentService --> User: 返回支付结果
deactivate PaymentService

== 优惠券退款流程 ==

User -> OrderService: 申请退款
activate OrderService

OrderService -> OrderService: 验证退款条件
OrderService -> DB: 更新订单状态
activate DB
DB --> OrderService: 确认状态更新
deactivate DB

OrderService -> CouponService: 处理优惠券退款
activate CouponService

CouponService -> DB: 查询优惠券使用记录
activate DB
DB --> CouponService: 返回使用记录
deactivate DB

CouponService -> CouponService: 计算退款金额
CouponService -> DB: 恢复优惠券状态
activate DB
DB --> CouponService: 确认状态恢复
deactivate DB

CouponService -> DB: 更新使用记录
activate DB
DB --> CouponService: 确认更新
deactivate DB

CouponService -> DB: 更新统计数据
activate DB
DB --> CouponService: 确认更新
deactivate DB

CouponService -> MQ: 发送退款事件
activate MQ
MQ --> CouponService: 确认事件发送
deactivate MQ

CouponService --> OrderService: 返回退款处理结果
deactivate CouponService

OrderService -> NotificationService: 发送退款通知
activate NotificationService
NotificationService --> OrderService: 确认通知发送
deactivate NotificationService

OrderService --> User: 返回退款结果
deactivate OrderService

@enduml 