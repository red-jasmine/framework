---
title: 邀请码管理
outline: deep
order: 1
---

# 邀请码管理

## 介绍

邀请码管理是邀请领域的核心子模块，负责邀请码的创建、生成、验证、状态管理等功能。作为整个邀请营销体系的基础，该模块确保邀请码的唯一性、有效性和可控性，支持多种业务场景下的推广需求。

## 领域模型

邀请码作为聚合根，封装了邀请营销的核心业务逻辑和数据：

```plantuml
<!--@include: ./invitation_code_detail.puml-->
```

### 核心实体与值对象

#### 邀请码聚合根 (InvitationCode)
- **标识属性**：唯一ID、邀请码字符串
- **归属信息**：邀请人类型、ID、名称
- **内容属性**：标题、描述、广告语
- **配置属性**：生成类型、最大使用次数、有效期
- **状态属性**：当前状态、已使用次数
- **关联集合**：去向配置、标签信息

#### 邀请人值对象 (Inviter)
- **类型标识**：用户、商户、代理商等类型
- **身份信息**：唯一标识和显示名称

#### 邀请标签值对象 (InvitationTag)
- **标签名称**：标签的分类名称
- **标签值**：具体的标签内容

## 领域事件

### 邀请码创建事件 (InvitationCodeCreated)
- **触发时机**：成功创建新邀请码时
- **事件数据**：邀请码完整信息
- **业务影响**：
  - 初始化相关配置
  - 发送创建通知
  - 更新统计基础数据

### 邀请码使用事件 (InvitationCodeUsed)
- **触发时机**：邀请码被访客使用时
- **事件数据**：使用者信息、使用行为、平台信息
- **业务影响**：
  - 更新使用次数
  - 记录使用日志
  - 触发统计更新
  - 检查状态变更

### 邀请码过期事件 (InvitationCodeExpired)
- **触发时机**：邀请码过期或达到使用上限时
- **事件数据**：邀请码信息、过期原因
- **业务影响**：
  - 更新状态为过期
  - 清理相关缓存
  - 发送过期通知

### 邀请码状态变更事件 (InvitationCodeStatusChanged)
- **触发时机**：邀请码状态发生变更时
- **事件数据**：原状态、新状态、变更原因
- **业务影响**：
  - 记录状态变更历史
  - 通知相关系统
  - 更新缓存状态

## 核心规则

### 邀请码生成规则

#### 自定义邀请码规则
- **长度限制**：4-20个字符
- **字符集限制**：支持字母、数字、下划线、短横线
- **敏感词过滤**：不能包含系统保留词和违规词汇
- **唯一性验证**：全系统内必须唯一
- **格式验证**：不能以数字开头，不能全为数字

#### 系统生成规则
- **默认长度**：8个字符
- **安全字符集**：排除易混淆字符（0、O、1、I、L等）
- **生成算法**：基于时间戳、用户ID、随机因子组合
- **重试机制**：生成冲突时最多重试3次
- **分布规则**：确保生成的码值均匀分布

### 有效期管理规则

#### 时间范围约束
- **最短有效期**：1小时
- **最长有效期**：365天
- **延期限制**：每个邀请码最多可延期3次
- **宽限期**：过期后24小时内仍可使用，显示过期提醒

#### 过期处理规则
- **自动过期**：系统定时检查并标记过期邀请码
- **状态变更**：过期后自动变更为EXPIRED状态
- **数据保留**：过期邀请码的历史数据永久保留
- **关联处理**：过期后相关配置保持不变，用于历史分析

### 使用次数控制规则

#### 使用模式定义
- **无限制模式**：maxUsage = 0，不限制使用次数
- **有限次数模式**：maxUsage > 0，达到限制后自动禁用
- **单次使用模式**：maxUsage = 1，使用一次后即失效
- **批量使用模式**：适用于群体邀请的多次使用场景

#### 并发控制策略
- **原子性保证**：使用次数更新必须是原子操作
- **乐观锁机制**：防止并发访问导致的计数错误
- **一致性检查**：定期校验使用次数的准确性
- **异常恢复**：并发冲突时的重试和补偿机制

### 状态管理规则

#### 状态转换规则
- **ACTIVE → DISABLED**：人工禁用或达到使用上限
- **ACTIVE → EXPIRED**：超过有效期自动过期
- **DISABLED → ACTIVE**：管理员手动重新启用
- **EXPIRED → ACTIVE**：延期后重新激活

#### 状态约束规则
- **创建时状态**：默认为ACTIVE状态
- **状态一致性**：状态变更必须符合业务规则
- **历史记录**：所有状态变更都有详细记录
- **权限控制**：只有授权用户才能变更状态

### 标签管理规则

#### 标签格式规范
- **名称规范**：标签名称采用小写字母和下划线
- **值约束**：标签值长度不超过100个字符
- **数量限制**：每个邀请码最多支持10个标签
- **重复检查**：同名标签不能重复添加

#### 标签业务规则
- **分类统计**：标签用于多维度数据分析
- **渠道识别**：通过标签区分不同推广渠道
- **效果追踪**：标签支持精准的效果归因分析
- **动态管理**：支持标签的动态添加和删除

## 业务不变式

### 数据一致性不变式
- 邀请码在系统中必须保持全局唯一性
- 已使用次数不能超过设定的最大使用次数
- 过期时间必须大于或等于创建时间
- 状态变更必须符合预定义的状态机规则

### 业务逻辑不变式
- 邀请码一旦创建，其码值不能被修改
- 已产生使用记录的邀请码不能被删除
- 过期的邀请码在宽限期外不能被使用
- 禁用状态的邀请码不能产生新的使用记录

### 关系完整性不变式
- 每个邀请码必须有明确的归属邀请人
- 邀请码的去向配置至少包含一个默认去向
- 删除邀请码时必须级联处理相关配置数据
- 邀请人信息变更时不影响已创建的邀请码 