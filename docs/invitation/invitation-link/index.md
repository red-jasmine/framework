---
title: 邀请链接管理
outline: deep
---

# 邀请链接管理

## 介绍

邀请链接管理子模块负责生成和管理适配不同平台的邀请链接，通过去向配置和平台适配机制，确保用户在不同设备和平台上都能获得最佳的访问体验。该模块是连接邀请码与具体业务页面的重要桥梁。

## 领域模型

邀请链接管理涉及去向配置、平台适配等关键概念：

```plantuml
<!--@include: ./invitation_link_detail.puml-->
```

### 核心实体与值对象

#### 邀请去向实体 (InvitationDestination)
- **基础信息**：去向ID、所属邀请码、去向类型
- **目标配置**：目标页面ID、目标URL
- **平台信息**：平台类型、平台特有配置
- **显示属性**：是否默认去向、排序权重

#### 邀请链接值对象 (InvitationLink)
- **链接地址**：完整的可访问URL
- **平台标识**：目标平台类型
- **参数集合**：传递的业务参数

#### 去向类型枚举 (DestinationType)
- **REGISTER**：用户注册页面
- **PRODUCT**：商品详情页面
- **ACTIVITY**：营销活动页面
- **HOME**：平台首页
- **CUSTOM**：自定义页面

#### 平台类型枚举 (PlatformType)
- **WEB**：桌面网页版
- **H5**：移动网页版
- **MINIPROGRAM**：小程序
- **APP**：移动应用

## 领域事件

### 去向配置创建事件 (InvitationDestinationCreated)
- **触发时机**：为邀请码配置新的去向时
- **事件数据**：去向配置信息、关联邀请码
- **业务影响**：
  - 更新邀请码的可用去向
  - 验证配置的有效性
  - 刷新相关缓存

### 去向配置更新事件 (InvitationDestinationUpdated)
- **触发时机**：修改现有去向配置时
- **事件数据**：原配置、新配置、变更内容
- **业务影响**：
  - 重新验证配置有效性
  - 更新已生成的链接
  - 通知相关系统

### 链接生成事件 (InvitationLinkGenerated)
- **触发时机**：成功生成邀请链接时
- **事件数据**：链接信息、生成上下文
- **业务影响**：
  - 记录链接生成日志
  - 更新统计数据
  - 缓存链接信息

### 平台访问事件 (PlatformAccessEvent)
- **触发时机**：用户通过邀请链接访问时
- **事件数据**：访问平台、用户信息、访问时间
- **业务影响**：
  - 记录平台访问统计
  - 触发平台适配逻辑
  - 更新转化数据

## 核心规则

### 去向配置规则

#### 配置完整性规则
- **必填字段**：去向类型、平台类型为必填项
- **URL有效性**：自定义URL必须是有效的HTTP/HTTPS链接
- **平台兼容性**：去向类型与平台类型必须兼容
- **默认去向**：每个邀请码至少有一个默认去向

#### 配置优先级规则
- **排序规则**：按照sort_order字段升序排列
- **默认优先**：默认去向在同优先级中排在前面
- **平台匹配**：优先选择与访问平台匹配的去向
- **降级处理**：不支持的平台自动降级到Web版本

### 链接生成规则

#### 参数传递规则
- **必传参数**：邀请码参数必须传递
- **平台参数**：根据目标平台添加特定参数
- **业务参数**：保持业务参数的完整性
- **参数编码**：所有参数必须进行URL编码

#### 链接格式规则
- **协议要求**：支持HTTP和HTTPS协议
- **长度限制**：完整链接长度不超过2048字符
- **字符集**：仅支持URL安全字符
- **参数分隔**：使用标准的URL参数分隔符

### 平台适配规则

#### 自动识别规则
- **User-Agent解析**：根据用户代理字符串识别平台
- **域名匹配**：根据访问域名确定平台类型
- **参数标识**：通过URL参数明确指定平台
- **默认处理**：无法识别时默认为Web平台

#### 跳转处理规则
- **直接跳转**：目标平台与当前平台一致时直接跳转
- **引导跳转**：不同平台时显示跳转引导页面
- **应用调起**：支持的情况下尝试调起原生应用
- **降级处理**：应用调起失败时降级到H5页面

### 缓存管理规则

#### 缓存策略规则
- **链接缓存**：生成的链接缓存30分钟
- **配置缓存**：去向配置缓存1小时
- **平台映射**：平台适配规则缓存24小时
- **失效策略**：配置更新时立即失效相关缓存

#### 缓存键规则
- **链接缓存键**：invitation_link:{code}:{platform}
- **配置缓存键**：invitation_destination:{code_id}
- **映射缓存键**：platform_mapping:{user_agent_hash}
- **命名规范**：统一使用冒号分隔的层级结构

### 安全性规则

#### 参数安全规则
- **参数过滤**：过滤敏感和危险参数
- **防注入**：防止SQL注入和XSS攻击
- **参数验证**：严格验证参数格式和类型
- **敏感信息**：避免在URL中暴露敏感信息

#### 访问安全规则
- **防刷机制**：限制单IP的访问频率
- **黑名单**：阻止恶意IP的访问
- **日志记录**：记录所有访问和操作日志
- **异常监控**：监控异常访问模式

## 业务不变式

### 配置一致性不变式
- 每个邀请码必须至少有一个有效的去向配置
- 默认去向在同一邀请码下保持唯一性
- 去向配置的平台类型必须在支持范围内
- 删除去向配置时不能删除最后一个配置

### 链接有效性不变式
- 生成的邀请链接必须包含有效的邀请码参数
- 链接的目标地址必须是可访问的有效URL
- 平台适配后的链接必须保持参数完整性
- 链接生成失败时必须有明确的错误信息

### 平台兼容性不变式
- 所有支持的平台都必须有对应的适配逻辑
- 平台特有的参数不能影响其他平台的正常访问
- 不支持的平台必须能够正确降级到支持的平台
- 平台间的跳转必须保持用户会话的连续性 