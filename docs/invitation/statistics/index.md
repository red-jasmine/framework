---
title: 统计分析
outline: deep
---

# 统计分析

## 介绍

统计分析子模块负责收集、计算和分析邀请营销活动的各项数据指标，为业务决策提供数据支撑。通过多维度的数据统计和深度分析，帮助用户了解邀请效果、优化营销策略。

## 领域模型

统计分析围绕邀请统计和使用记录等核心数据展开：

```plantuml
<!--@include: ./statistics_detail.puml-->
```

### 核心实体与值对象

#### 邀请统计实体 (InvitationStatistics)
- **基础信息**：统计ID、邀请码ID、统计日期
- **访问数据**：访问次数、独立访客数、跳出率
- **转化数据**：注册数、下单数、订单金额
- **互动数据**：分享次数、收藏数、评论数
- **效果指标**：转化率、客单价、ROI

#### 使用记录实体 (InvitationUsageLog)
- **基础信息**：记录ID、邀请码信息、记录时间
- **用户信息**：用户类型、用户ID、访客标识
- **行为数据**：操作类型、访问平台、交互内容
- **环境信息**：IP地址、用户代理、来源页面
- **扩展数据**：自定义统计字段

#### 操作类型枚举 (ActionType)
- **VISIT**：访问邀请链接
- **REGISTER**：完成用户注册
- **ORDER**：产生订单行为
- **SHARE**：分享邀请内容

## 领域事件

### 统计数据更新事件 (StatisticsDataUpdated)
- **触发时机**：统计数据发生变化时
- **事件数据**：统计维度、数据变化、更新时间
- **业务影响**：
  - 刷新实时统计显示
  - 触发告警检查
  - 更新排行榜数据

### 使用记录创建事件 (UsageLogCreated)
- **触发时机**：产生新的使用记录时
- **事件数据**：完整的使用记录信息
- **业务影响**：
  - 实时更新统计数据
  - 触发行为分析
  - 更新用户画像

### 统计报告生成事件 (StatisticsReportGenerated)
- **触发时机**：定期生成统计报告时
- **事件数据**：报告内容、时间范围、接收者
- **业务影响**：
  - 发送报告通知
  - 归档历史数据
  - 触发趋势分析

### 异常数据检测事件 (AnomalyDataDetected)
- **触发时机**：检测到异常数据时
- **事件数据**：异常类型、异常数据、检测时间
- **业务影响**：
  - 发送异常告警
  - 暂停相关统计
  - 启动数据校验

## 核心规则

### 数据收集规则  

#### 实时收集规则
- **触发条件**：用户行为发生时立即记录
- **数据完整性**：确保关键字段的完整性
- **去重机制**：防止重复数据的产生
- **时效性要求**：收集延迟不超过5秒

#### 批量收集规则
- **收集频率**：每5分钟批量处理一次
- **数据聚合**：按邀请码和时间维度聚合
- **异常处理**：收集失败的重试和补偿机制
- **数据验证**：收集数据的合法性验证

### 统计计算规则

#### 基础指标计算规则
- **访问量统计**：按唯一访客和总访问次数分别统计
- **转化率计算**：转化数/访问数，保留4位小数
- **平均值计算**：总和/数量，处理除零异常
- **增长率计算**：(当前值-历史值)/历史值*100%

#### 复合指标计算规则
- **活跃度评分**：综合访问、分享、转化等多维度数据
- **质量评分**：基于转化率、用户留存等质量指标
- **趋势分析**：基于历史数据的趋势预测和分析
- **对比分析**：同期对比、环比、同比等多维度对比

### 数据存储规则

#### 原始数据存储规则
- **保存周期**：原始日志数据保存180天
- **存储格式**：JSON格式存储，便于查询和分析
- **分区策略**：按日期分区存储，提高查询效率
- **备份机制**：重要数据的异地备份

#### 统计数据存储规则
- **汇总粒度**：支持小时、日、周、月多种粒度
- **存储周期**：汇总数据永久保存
- **索引优化**：按查询模式建立复合索引
- **数据压缩**：历史数据的压缩存储

### 报表生成规则

#### 实时报表规则
- **更新频率**：实时数据每5分钟更新一次
- **数据源**：直接从统计汇总表获取数据
- **缓存策略**：实时报表缓存5分钟
- **并发控制**：限制同时生成的报表数量

#### 定期报表规则
- **生成周期**：日报、周报、月报定期自动生成
- **发送机制**：按订阅列表自动发送报表
- **格式支持**：支持PDF、Excel、HTML多种格式
- **个性化定制**：支持用户自定义报表内容

### 数据分析规则

#### 异常检测规则
- **阈值设定**：关键指标的异常阈值设定
- **检测算法**：基于统计学的异常检测算法
- **告警机制**：异常情况的及时告警通知
- **处理流程**：异常数据的处理和修复流程

#### 趋势分析规则
- **周期识别**：识别数据的周期性规律
- **趋势预测**：基于历史数据的趋势预测
- **季节性调整**：考虑季节性因素的数据调整
- **置信区间**：预测结果的置信区间计算

### 数据安全规则

#### 数据脱敏规则
- **敏感信息**：用户个人信息的脱敏处理
- **脱敏方法**：哈希、掩码、泛化等脱敏方法
- **权限控制**：不同角色的数据访问权限
- **审计日志**：数据访问的完整审计记录

#### 数据权限规则
- **分级授权**：按数据敏感级别分级授权
- **最小权限**：遵循最小权限原则
- **权限审计**：定期审计用户权限
- **权限回收**：及时回收离职人员权限

## 业务不变式

### 数据一致性不变式
- 统计数据必须与原始记录数据保持一致
- 各维度统计数据之间不能出现逻辑矛盾
- 历史统计数据一旦确认不能随意修改
- 数据更新必须保持原子性和一致性

### 计算准确性不变式
- 所有比率和百分比计算必须处理除零情况
- 金额相关计算必须保持精度不丢失
- 时间相关统计必须考虑时区问题
- 聚合统计必须正确处理重复数据

### 时效性保证不变式
- 实时统计的延迟不能超过设定阈值
- 定期报表必须按时自动生成
- 数据异常必须在检测到后立即告警
- 历史数据查询的响应时间有合理上限

### 业务逻辑完整性不变式
- 统计维度必须覆盖所有重要的业务指标
- 异常数据检测必须有完整的处理流程
- 数据权限控制必须覆盖所有数据访问路径
- 统计报表必须包含数据来源和计算方法说明 