# 商品领域国际化改造 - 快速指南

## 🌍 核心变化概览

### 表名变化

| 当前表名 | 国际化建议 | 变化说明 |
|---------|-----------|---------|
| `products` | `products` ✅ | 保持不变 |
| `product_skus` | `product_variants` | 🔄 更国际化，可保持sku作为别名 |
| `product_stock_logs` | `inventory_history` | 🔄 更符合国际术语 |

**建议：** 表名可以保持 `product_skus`，但在代码和API层使用 `variants` 术语

## 📋 必须添加的国际化字段

### Product 表必须字段

```sql
-- 1. URL友好标识（Shopify风格，SEO必备）
ALTER TABLE products 
ADD COLUMN handle VARCHAR(255) UNIQUE COMMENT 'URL-friendly unique identifier';

-- 2. 发布状态（区分草稿和发布）
ALTER TABLE products
ADD COLUMN published BOOLEAN DEFAULT FALSE COMMENT 'Is published to storefront',
ADD COLUMN published_at TIMESTAMP NULL COMMENT 'Published datetime (UTC)';

-- 3. 单位标准化
ALTER TABLE products
ADD COLUMN weight_unit VARCHAR(10) DEFAULT 'kg' COMMENT 'Weight unit: kg, g, lb, oz';

-- 4. SEO字段
ALTER TABLE products
ADD COLUMN meta_title VARCHAR(255) NULL COMMENT 'SEO page title',
ADD COLUMN meta_description TEXT NULL COMMENT 'SEO meta description';

-- 5. 税务合规
ALTER TABLE products
ADD COLUMN taxable BOOLEAN DEFAULT TRUE COMMENT 'Subject to taxes',
ADD COLUMN tax_code VARCHAR(64) NULL COMMENT 'Tax category/code';

-- 6. 物流标识
ALTER TABLE products
ADD COLUMN requires_shipping BOOLEAN DEFAULT TRUE COMMENT 'Is physical product requiring shipping';

-- 7. 国际贸易
ALTER TABLE products
ADD COLUMN origin_country CHAR(2) NULL COMMENT 'Country of origin (ISO 3166-1)',
ADD COLUMN hs_code VARCHAR(32) NULL COMMENT 'Harmonized System code for customs';

-- 8. 品牌术语（Shopify使用vendor）
ALTER TABLE products
ADD COLUMN vendor VARCHAR(255) NULL COMMENT 'Brand/Vendor name';
```

### ProductSku/Variant 表必须字段

```sql
-- 1. 单位字段
ALTER TABLE product_skus
ADD COLUMN weight_unit VARCHAR(10) DEFAULT 'kg' COMMENT 'Weight unit',
ADD COLUMN dimension_unit VARCHAR(10) DEFAULT 'm' COMMENT 'Dimension unit: m, cm, in, ft';

-- 2. 条码类型
ALTER TABLE product_skus
ADD COLUMN barcode_type VARCHAR(32) NULL COMMENT 'Barcode type: UPC, EAN13, EAN8, ISBN';

-- 3. 库存策略
ALTER TABLE product_skus
ADD COLUMN inventory_policy VARCHAR(32) DEFAULT 'deny' COMMENT 'deny|continue when out of stock';

-- 4. 选项值（Shopify风格）
ALTER TABLE product_skus
ADD COLUMN option1 VARCHAR(255) NULL COMMENT 'First option value (e.g., Red)',
ADD COLUMN option2 VARCHAR(255) NULL COMMENT 'Second option value (e.g., Large)',
ADD COLUMN option3 VARCHAR(255) NULL COMMENT 'Third option value';

-- 5. 税务标识
ALTER TABLE product_skus
ADD COLUMN taxable BOOLEAN DEFAULT TRUE COMMENT 'Subject to taxes',
ADD COLUMN tax_code VARCHAR(64) NULL COMMENT 'Tax category code';

-- 6. 物流标识
ALTER TABLE product_skus
ADD COLUMN requires_shipping BOOLEAN DEFAULT TRUE COMMENT 'Needs shipping';

-- 7. 位置/排序
ALTER TABLE product_skus
ADD COLUMN position TINYINT UNSIGNED DEFAULT 1 COMMENT 'Display order';
```

## 🗂️ 新建的国际化表

### 1. 多语言翻译表

```sql
-- Product翻译表
CREATE TABLE product_translations (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    product_id BIGINT UNSIGNED NOT NULL,
    locale VARCHAR(10) NOT NULL COMMENT 'en-US, zh-CN, fr-FR',
    
    title VARCHAR(255) NOT NULL,
    description TEXT,
    meta_title VARCHAR(255),
    meta_description TEXT,
    
    created_at TIMESTAMP NULL,
    updated_at TIMESTAMP NULL,
    
    UNIQUE KEY idx_product_locale (product_id, locale),
    FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
);

-- Variant翻译表
CREATE TABLE variant_translations (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    variant_id BIGINT UNSIGNED NOT NULL,
    locale VARCHAR(10) NOT NULL,
    
    title VARCHAR(255),
    option1 VARCHAR(255),
    option2 VARCHAR(255),
    option3 VARCHAR(255),
    
    created_at TIMESTAMP NULL,
    updated_at TIMESTAMP NULL,
    
    UNIQUE KEY idx_variant_locale (variant_id, locale),
    FOREIGN KEY (variant_id) REFERENCES product_skus(id) ON DELETE CASCADE
);
```

### 2. 多货币价格表

```sql
CREATE TABLE variant_prices (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    variant_id BIGINT UNSIGNED NOT NULL,
    currency CHAR(3) NOT NULL COMMENT 'ISO 4217: USD, EUR, CNY',
    market VARCHAR(32) NULL COMMENT 'Optional market identifier',
    
    price DECIMAL(12,2) NOT NULL,
    compare_at_price DECIMAL(12,2) NULL,
    
    effective_from TIMESTAMP NULL COMMENT 'Price start date (UTC)',
    effective_until TIMESTAMP NULL COMMENT 'Price end date (UTC)',
    
    created_at TIMESTAMP NULL,
    updated_at TIMESTAMP NULL,
    
    UNIQUE KEY idx_variant_currency_market (variant_id, currency, market),
    FOREIGN KEY (variant_id) REFERENCES product_skus(id) ON DELETE CASCADE
);
```

### 3. 选项配置表（Shopify风格）

```sql
CREATE TABLE product_options (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    product_id BIGINT UNSIGNED NOT NULL,
    name VARCHAR(100) NOT NULL COMMENT 'Color, Size, Material',
    position TINYINT UNSIGNED DEFAULT 1,
    values JSON NOT NULL COMMENT '["Red", "Blue", "Green"]',
    
    created_at TIMESTAMP NULL,
    updated_at TIMESTAMP NULL,
    
    INDEX idx_product (product_id),
    FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
);
```

## 🔄 字段重命名建议

### 推荐重命名（提升国际化）

```sql
-- Product表
ALTER TABLE products
CHANGE COLUMN slogan subtitle VARCHAR(255) NULL,
CHANGE COLUMN product_model model_number VARCHAR(255) NULL,
CHANGE COLUMN sales total_sales_count BIGINT UNSIGNED DEFAULT 0,
CHANGE COLUMN views views_count BIGINT UNSIGNED DEFAULT 0,
CHANGE COLUMN likes likes_count BIGINT UNSIGNED DEFAULT 0,
CHANGE COLUMN favorites favorites_count BIGINT UNSIGNED DEFAULT 0,
CHANGE COLUMN gift_point gift_points INT UNSIGNED DEFAULT 0;

-- ProductSku表
ALTER TABLE product_skus
CHANGE COLUMN properties_name variant_title VARCHAR(255),
CHANGE COLUMN properties_sequence variant_options VARCHAR(255),
CHANGE COLUMN sales sales_count BIGINT UNSIGNED DEFAULT 0;
```

### 可选重命名（表名国际化）

```sql
-- 如果要彻底国际化，可以重命名表
RENAME TABLE product_skus TO product_variants;
RENAME TABLE product_stock_logs TO inventory_history;
```

## 📐 数据类型标准化

### 物理属性优化

```sql
ALTER TABLE product_skus
CHANGE COLUMN weight weight DECIMAL(10,3) NULL COMMENT 'Weight in specified unit',
CHANGE COLUMN width width DECIMAL(8,2) NULL COMMENT 'Width in specified unit',
CHANGE COLUMN height height DECIMAL(8,2) NULL COMMENT 'Height in specified unit',
CHANGE COLUMN length length DECIMAL(8,2) NULL COMMENT 'Length in specified unit',
CHANGE COLUMN size volume DECIMAL(10,4) NULL COMMENT 'Volume in cubic meters';
```

### 货币字段标准化

```sql
-- 确保所有价格字段使用 DECIMAL(12,2)
ALTER TABLE products
MODIFY COLUMN price DECIMAL(12,2),
MODIFY COLUMN market_price DECIMAL(12,2),
MODIFY COLUMN cost_price DECIMAL(12,2);

ALTER TABLE product_skus
MODIFY COLUMN price DECIMAL(12,2),
MODIFY COLUMN market_price DECIMAL(12,2),
MODIFY COLUMN cost_price DECIMAL(12,2);
```

## 🌐 国际化代码标准

### 货币代码（ISO 4217）

```php
const SUPPORTED_CURRENCIES = [
    'USD' => 'US Dollar',
    'EUR' => 'Euro',
    'GBP' => 'British Pound',
    'JPY' => 'Japanese Yen',
    'CNY' => 'Chinese Yuan',
    'AUD' => 'Australian Dollar',
    'CAD' => 'Canadian Dollar',
    'CHF' => 'Swiss Franc',
    'HKD' => 'Hong Kong Dollar',
    'SGD' => 'Singapore Dollar',
];
```

### 语言代码（ISO 639-1 + Region）

```php
const SUPPORTED_LOCALES = [
    'en-US' => 'English (United States)',
    'en-GB' => 'English (United Kingdom)',
    'zh-CN' => 'Chinese (Simplified)',
    'zh-TW' => 'Chinese (Traditional)',
    'ja-JP' => 'Japanese',
    'ko-KR' => 'Korean',
    'fr-FR' => 'French',
    'de-DE' => 'German',
    'es-ES' => 'Spanish',
    'it-IT' => 'Italian',
];
```

### 国家代码（ISO 3166-1 alpha-2）

```php
const SUPPORTED_COUNTRIES = [
    'US' => 'United States',
    'CN' => 'China',
    'GB' => 'United Kingdom',
    'FR' => 'France',
    'DE' => 'Germany',
    'JP' => 'Japan',
    'CA' => 'Canada',
    'AU' => 'Australia',
    // ...
];
```

### 单位标准

```php
// 重量单位
const WEIGHT_UNITS = [
    'kg'  => 'Kilogram',     // 推荐（SI标准）
    'g'   => 'Gram',
    'lb'  => 'Pound',
    'oz'  => 'Ounce',
];

// 尺寸单位
const DIMENSION_UNITS = [
    'm'   => 'Meter',        // 推荐（SI标准）
    'cm'  => 'Centimeter',
    'in'  => 'Inch',
    'ft'  => 'Foot',
];
```

## 📊 API 响应国际化

### 双重支持（兼容性）

```php
class ProductResource extends JsonResource
{
    public function toArray($request)
    {
        return [
            'id' => $this->id,
            'handle' => $this->handle,  // 新增：URL友好标识
            'title' => $this->getTranslatedTitle(),
            
            // 国际化术语（推荐）
            'vendor' => $this->brand?->name ?? $this->vendor,
            'product_type' => $this->product_type,
            'published' => $this->published,
            'published_at' => $this->published_at?->toIso8601String(),
            
            // 变体（国际化术语）
            'has_variants' => $this->has_variants,
            'variants' => ProductVariantResource::collection(
                $this->whenLoaded('skus')
            ),
            
            // 向后兼容（中国术语）
            'skus' => ProductVariantResource::collection(
                $this->whenLoaded('skus')
            ),
            
            // 价格（包含货币）
            'price' => [
                'amount' => $this->base_price,
                'currency' => $this->currency,
                'formatted' => $this->formatPrice($this->base_price, $this->currency),
            ],
            
            // SEO
            'seo' => [
                'title' => $this->meta_title,
                'description' => $this->meta_description,
            ],
            
            // 翻译
            'translations' => $this->translations->keyBy('locale'),
        ];
    }
}
```

### Variant Resource

```php
class ProductVariantResource extends JsonResource
{
    public function toArray($request)
    {
        return [
            'id' => $this->id,
            
            // Shopify风格
            'title' => $this->variant_title ?? $this->properties_name,
            'sku' => $this->sku,
            'barcode' => $this->barcode,
            'barcode_type' => $this->barcode_type,
            
            // 选项值
            'option1' => $this->option1,
            'option2' => $this->option2,
            'option3' => $this->option3,
            
            // 价格
            'price' => [
                'amount' => $this->price,
                'currency' => $this->currency,
            ],
            'compare_at_price' => $this->compare_at_price ? [
                'amount' => $this->compare_at_price,
                'currency' => $this->currency,
            ] : null,
            
            // 库存
            'inventory_quantity' => $this->stock,
            'inventory_policy' => $this->inventory_policy ?? 'deny',
            
            // 物理属性（带单位）
            'weight' => [
                'value' => $this->weight,
                'unit' => $this->weight_unit ?? 'kg',
            ],
            'dimensions' => [
                'length' => $this->length,
                'width' => $this->width,
                'height' => $this->height,
                'unit' => $this->dimension_unit ?? 'm',
            ],
            
            // 标识
            'requires_shipping' => $this->requires_shipping ?? true,
            'taxable' => $this->taxable ?? true,
        ];
    }
}
```

## ✅ 实施检查清单

### 阶段一：必须字段（1-2周）

- [ ] 添加 `handle` 字段到products表
- [ ] 添加 `published`, `published_at` 字段
- [ ] 添加单位字段：`weight_unit`, `dimension_unit`
- [ ] 修改物理属性为 decimal 类型
- [ ] 添加 `taxable`, `requires_shipping` 字段
- [ ] 添加 `meta_title`, `meta_description` 字段
- [ ] 为现有数据生成 handle 值
- [ ] 更新API Resource支持新字段

### 阶段二：翻译支持（2-4周）

- [ ] 创建 `product_translations` 表
- [ ] 创建 `variant_translations` 表
- [ ] 实现多语言查询逻辑
- [ ] 更新API支持locale参数
- [ ] 创建翻译管理界面

### 阶段三：多货币（4-6周）

- [ ] 创建 `variant_prices` 表
- [ ] 实现货币转换服务
- [ ] 支持按市场定价
- [ ] 更新API支持currency参数
- [ ] 实现汇率管理

### 阶段四：选项系统（可选）

- [ ] 创建 `product_options` 表
- [ ] 迁移现有销售属性到options
- [ ] 实现option到variant的映射
- [ ] 更新管理界面

### 阶段五：优化（长期）

- [ ] 字段重命名（slogan→subtitle等）
- [ ] 添加国际贸易字段
- [ ] 完善SEO支持
- [ ] 性能优化和缓存
- [ ] 国际化文档完善

## 🎯 关键决策

### 1. 表名：保留还是重命名？

**推荐方案：保留数据库表名，代码层使用别名**

```php
// 数据库表名保持不变
products
product_skus

// Model 层提供别名
class ProductVariant extends ProductSku {}

// API 层使用国际化术语
"variants": [...]
```

**优点：**
- ✅ 向后兼容
- ✅ 迁移成本低
- ✅ 对外国际化

### 2. 多语言：单表还是分表？

**推荐方案：独立翻译表**

```
products (基础数据，默认语言)
  ↓
product_translations (其他语言翻译)
```

**优点：**
- ✅ 性能更好（不翻译时不JOIN）
- ✅ 扩展性强
- ✅ 符合国际标准

### 3. 多货币：实时转换还是存储？

**推荐方案：混合方式**

```
variant_prices (主要市场固定价格)
+ 
汇率服务 (其他市场实时转换)
```

**优点：**
- ✅ 灵活性高
- ✅ 符合商业实践
- ✅ 性能可控

## 🚀 快速开始

### 最小可行方案（MVP）

```sql
-- 只需这3个改动就能支持基本国际化

-- 1. 添加handle（SEO必备）
ALTER TABLE products ADD COLUMN handle VARCHAR(255) UNIQUE;

-- 2. 添加单位（度量标准化）
ALTER TABLE products ADD COLUMN weight_unit VARCHAR(10) DEFAULT 'kg';
ALTER TABLE product_skus ADD COLUMN weight_unit VARCHAR(10) DEFAULT 'kg';
ALTER TABLE product_skus ADD COLUMN dimension_unit VARCHAR(10) DEFAULT 'm';

-- 3. 创建翻译表（多语言支持）
CREATE TABLE product_translations (...);
```

### 数据初始化

```php
// 生成handle
Product::whereNull('handle')->chunk(100, function ($products) {
    foreach ($products as $product) {
        $product->handle = Str::slug($product->title);
        $product->save();
    }
});

// 初始化单位
DB::table('products')->update(['weight_unit' => 'kg']);
DB::table('product_skus')->update([
    'weight_unit' => 'kg',
    'dimension_unit' => 'm'
]);
```

## 📚 参考资源

- [Shopify Product API](https://shopify.dev/api/admin-rest/2024-01/resources/product)
- [WooCommerce REST API](https://woocommerce.github.io/woocommerce-rest-api-docs/)
- [ISO 4217 Currency Codes](https://www.iso.org/iso-4217-currency-codes.html)
- [ISO 639-1 Language Codes](https://www.iso.org/iso-639-language-codes.html)
- [ISO 3166-1 Country Codes](https://www.iso.org/iso-3166-country-codes.html)

## 💡 最佳实践

1. **时间存储**：所有时间字段使用UTC，显示时转换为用户时区
2. **价格存储**：使用整数存储分/美分，避免浮点误差（可选）
3. **翻译回退**：查询翻译时，如果目标语言不存在，回退到默认语言
4. **SEO优化**：handle字段应包含关键词，利于搜索引擎
5. **API版本**：国际化改动大时，使用API版本控制
6. **缓存策略**：翻译和汇率数据应该缓存
7. **数据验证**：严格验证货币代码、语言代码等标准字段

