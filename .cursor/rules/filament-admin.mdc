---
globs: ["packages/filament-*/src/**/*.php"]
description: "Filament 管理界面编码规范，适用于基于 Filament 的管理面板开发"
---

# Filament 管理界面编码规范

## 包结构规范

### 包命名规范
- 使用 `filament-{domain}` 命名格式
- 例如：`filament-article`、`filament-admin`、`filament-core`

### 目录结构
```
filament/filament-{domain}/
├── src/
│   ├── {DomainName}ServiceProvider.php    # 服务提供者
│   ├── {DomainName}Plugin.php             # 插件类
│   ├── Clusters/                          # 功能集群
│   │   ├── {ClusterName}.php              # 集群定义
│   │   └── {ClusterName}/                 # 集群资源
│   │       └── Resources/                 # 资源文件
│   │           └── {Entity}/               # 实体资源目录
│   │               ├── {Entity}Resource.php
│   │               ├── Pages/             # 页面类
│   │               ├── Schemas/           # 表单配置类
│   │               └── Tables/            # 表格配置类
│   ├── Resources/                         # 独立资源
│   ├── Forms/                             # 表单组件
│   ├── Columns/                           # 列组件
│   ├── Filters/                           # 过滤器
│   ├── Actions/                           # 动作
│   └── Helpers/                           # 帮助类
├── config/
├── resources/
│   ├── lang/                              # 语言包
│   └── views/                             # 视图文件
└── composer.json
```

## 核心类规范

### 1. ServiceProvider 服务提供者
```php
<?php

namespace RedJasmine\Filament{Domain};

use Filament\Support\Assets\Asset;
use Filament\Support\Facades\FilamentAsset;
use Filament\Support\Facades\FilamentIcon;
use Spatie\LaravelPackageTools\Package;
use Spatie\LaravelPackageTools\PackageServiceProvider;

class Filament{Domain}ServiceProvider extends PackageServiceProvider
{
    public static string $name = 'red-jasmine-filament-{domain}';
    public static string $viewNamespace = 'red-jasmine-filament-{domain}';

    public function configurePackage(Package $package): void
    {
        $package->name(static::$name)
                ->hasCommands($this->getCommands())
                ->hasConfigFile()
                ->hasTranslations()
                ->hasViews(static::$viewNamespace);
    }

    public function packageBooted(): void
    {
        // 资源注册
        FilamentAsset::register(
            $this->getAssets(),
            $this->getAssetPackageName()
        );

        // 图标注册
        FilamentIcon::register($this->getIcons());

        // 宏定义
        $this->registerMacros();
    }
}
```

### 2. Plugin 插件类
```php
<?php

namespace RedJasmine\Filament{Domain};

use Filament\Contracts\Plugin;
use Filament\Panel;

class Filament{Domain}Plugin implements Plugin
{
    public function getId(): string
    {
        return 'red-jasmine-filament-{domain}';
    }

    public function register(Panel $panel): void
    {
        $panel->discoverClusters(
            in: __DIR__ . '/Clusters/',
            for: 'RedJasmine\\Filament{Domain}\\Clusters'
        );
    }

    public function boot(Panel $panel): void
    {
        // 启动逻辑
    }

    public static function make(): static
    {
        return app(static::class);
    }

    public static function get(): static
    {
        /** @var static $plugin */
        $plugin = filament(app(static::class)->getId());
        return $plugin;
    }
}
```

### 3. Cluster 集群类
```php
<?php

namespace RedJasmine\Filament{Domain}\Clusters;

use Filament\Clusters\Cluster;

class {ClusterName} extends Cluster
{
    protected static ?string $navigationIcon = 'heroicon-c-document-text';

    public static function getNavigationLabel(): string
    {
        return __('red-jasmine-filament-{domain}::{cluster}.label');
    }

    public static function getClusterBreadcrumb(): ?string
    {
        return __('red-jasmine-filament-{domain}::{cluster}.label');
    }
}
```

## 资源类规范

### 1. Resource 资源类
```php
<?php

namespace RedJasmine\Filament{Domain}\Clusters\{ClusterName}\Resources\{Entity};

use BackedEnum;
use Filament\Resources\Resource;
use Filament\Schemas\Schema;
use Filament\Tables\Table;
use RedJasmine\{Domain}\Application\{Entity}\Services\{Entity}ApplicationService;
use RedJasmine\{Domain}\Application\{Entity}\Services\Commands\{Entity}CreateCommand;
use RedJasmine\{Domain}\Application\{Entity}\Services\Commands\{Entity}DeleteCommand;
use RedJasmine\{Domain}\Application\{Entity}\Services\Commands\{Entity}UpdateCommand;
use RedJasmine\{Domain}\Domain\{Entity}\Models\{Entity} as Model;
use RedJasmine\FilamentCore\Helpers\ResourcePageHelper;
use RedJasmine\Filament{Domain}\Clusters\{ClusterName}\Resources\{Entity}\Pages\Create{Entity};
use RedJasmine\Filament{Domain}\Clusters\{ClusterName}\Resources\{Entity}\Pages\Edit{Entity};
use RedJasmine\Filament{Domain}\Clusters\{ClusterName}\Resources\{Entity}\Pages\List{Entities};
use RedJasmine\Filament{Domain}\Clusters\{ClusterName}\Resources\{Entity}\Pages\View{Entity};
use RedJasmine\Filament{Domain}\Clusters\{ClusterName}\Resources\{Entity}\Schemas\{Entity}Form;
use RedJasmine\Filament{Domain}\Clusters\{ClusterName}\Resources\{Entity}\Tables\{Entity}Table;
use RedJasmine\Support\Domain\Data\Queries\FindQuery;

class {Entity}Resource extends Resource
{
    use ResourcePageHelper;

    /**
     * @var class-string<{Entity}ApplicationService>
     */
    protected static string $service = {Entity}ApplicationService::class;

    protected static ?string $createCommand = {Entity}CreateCommand::class;
    protected static ?string $updateCommand = {Entity}UpdateCommand::class;
    protected static ?string $deleteCommand = {Entity}DeleteCommand::class;

    protected static ?string $cluster = \RedJasmine\Filament{Domain}\Clusters\{ClusterName}::class;
    protected static ?string $model = Model::class;
    protected static ?int $navigationSort = 1;
    protected static string|BackedEnum|null $navigationIcon = 'heroicon-o-document-text';
    protected static bool $onlyOwner = true;

    public static function getPages(): array
    {
        return [
            'index' => List{Entities}::route('/'),
            'create' => Create{Entity}::route('/create'),
            'view' => View{Entity}::route('/{record}'),
            'edit' => Edit{Entity}::route('/{record}/edit'),
        ];
    }

    public static function getModelLabel(): string
    {
        return __('red-jasmine-{domain}::{entity}.labels.{entity}');
    }

    public static function callFindQuery(FindQuery $findQuery): FindQuery
    {
        $findQuery->include = ['relation1', 'relation2', 'extension'];
        return $findQuery;
    }

    public static function callResolveRecord(Model $model): Model
    {
        // 处理扩展表数据合并到主模型
        if ($model->relationLoaded('extension')) {
            foreach ($model->extension->getAttributes() as $key => $value) {
                $model->setAttribute($key, $model->extension->{$key});
            }
        }
        return $model;
    }

    public static function form(Schema $form): Schema
    {
        return {Entity}Form::configure($form);
    }

    public static function table(Table $table): Table
    {
        return {Entity}Table::configure($table);
    }
}
```

### 2. Page 页面类

#### CreateRecord 创建页面
```php
<?php

namespace RedJasmine\Filament{Domain}\Clusters\{ClusterName}\Resources\{Entity}\Pages;

use Filament\Resources\Pages\CreateRecord;
use RedJasmine\FilamentCore\Helpers\ResourcePageHelper;
use RedJasmine\Filament{Domain}\Clusters\{ClusterName}\Resources\{Entity}\{Entity}Resource;

class Create{Entity} extends CreateRecord
{
    protected static string $resource = {Entity}Resource::class;

    use ResourcePageHelper;
}
```

#### EditRecord 编辑页面
```php
<?php

namespace RedJasmine\Filament{Domain}\Clusters\{ClusterName}\Resources\{Entity}\Pages;

use Filament\Actions\DeleteAction;
use Filament\Resources\Pages\EditRecord;
use RedJasmine\FilamentCore\Helpers\ResourcePageHelper;
use RedJasmine\Filament{Domain}\Clusters\{ClusterName}\Resources\{Entity}\{Entity}Resource;

class Edit{Entity} extends EditRecord
{
    protected static string $resource = {Entity}Resource::class;

    protected function getHeaderActions(): array
    {
        return [
            DeleteAction::make(),
        ];
    }

    use ResourcePageHelper;
}
```

#### ViewRecord 查看页面
```php
<?php

namespace RedJasmine\Filament{Domain}\Clusters\{ClusterName}\Resources\{Entity}\Pages;

use Filament\Actions\EditAction;
use Filament\Resources\Pages\ViewRecord;
use RedJasmine\FilamentCore\Helpers\ResourcePageHelper;
use RedJasmine\Filament{Domain}\Clusters\{ClusterName}\Resources\{Entity}\{Entity}Resource;

class View{Entity} extends ViewRecord
{
    protected static string $resource = {Entity}Resource::class;

    protected function getHeaderActions(): array
    {
        return [
            EditAction::make(),
        ];
    }

    use ResourcePageHelper;
}
```

#### ListRecords 列表页面
```php
<?php

namespace RedJasmine\Filament{Domain}\Clusters\{ClusterName}\Resources\{Entity}\Pages;

use Filament\Actions\CreateAction;
use Filament\Resources\Pages\ListRecords;
use Filament\Schemas\Components\Tabs\Tab;
use Illuminate\Database\Eloquent\Builder;
use RedJasmine\Filament{Domain}\Clusters\{ClusterName}\Resources\{Entity}\{Entity}Resource;

class List{Entities} extends ListRecords
{
    protected static string $resource = {Entity}Resource::class;

    protected function getHeaderActions(): array
    {
        return [
            CreateAction::make(),
        ];
    }

    public function getTabs(): array
    {
        return [
            'all' => Tab::make()
                ->label(__('red-jasmine-{domain}::{entity}.scopes.all')),
            'active' => Tab::make()
                ->badge(static::getResource()::getEloquentQuery()->active()->count())
                ->label(__('red-jasmine-{domain}::{entity}.scopes.active'))
                ->modifyQueryUsing(fn(Builder $query) => $query->active()),
        ];
    }
}
```

## 表单和表格配置规范

### 1. Form Schema 表单配置类
```php
<?php

namespace RedJasmine\Filament{Domain}\Clusters\{ClusterName}\Resources\{Entity}\Schemas;

use Filament\Forms\Components\TextInput;
use Filament\Forms\Components\Toggle;
use Filament\Schemas\Components\Section;
use Filament\Schemas\Components\Tabs;
use Filament\Schemas\Components\Tabs\Tab;
use Filament\Schemas\Schema;
use RedJasmine\FilamentCore\Resources\Schemas\Operators;
use RedJasmine\FilamentCore\Resources\Schemas\Owner;

class {Entity}Form
{
    /**
     * 配置表单
     */
    public static function configure(Schema $form): Schema
    {
        $schema = [
            Tab::make('basic_info')
                ->label(__('red-jasmine-{domain}::{entity}.labels.basic_info'))
                ->columns(1)
                ->schema(static::basicInfoFields()),
            Tab::make('other')
                ->label(__('red-jasmine-{domain}::{entity}.labels.other'))
                ->columns(1)
                ->schema(static::otherFields()),
        ];

        return $form
            ->components([
                Tabs::make(__('red-jasmine-{domain}::{entity}.labels.{entity}'))
                    ->tabs($schema)
                    ->persistTabInQueryString(),
            ])
            ->inlineLabel(true)
            ->columns(1);
    }

    /**
     * 基础信息字段
     */
    protected static function basicInfoFields(): array
    {
        return [
            Owner::make(),

            Section::make('基础信息')
                ->description('设置基本信息')
                ->icon('heroicon-o-information-circle')
                ->columns(2)
                ->schema([
                    TextInput::make('name')
                        ->label(__('red-jasmine-{domain}::{entity}.fields.name'))
                        ->required()
                        ->maxLength(255),
                    // 更多字段...
                ]),
        ];
    }

    /**
     * 其他字段
     */
    protected static function otherFields(): array
    {
        return [
            Section::make('其他设置')
                ->columns(2)
                ->schema([
                    Toggle::make('is_active')
                        ->label(__('red-jasmine-{domain}::{entity}.fields.is_active'))
                        ->default(true),
                    // 更多字段...
                ]),
            Operators::make(),
        ];
    }
}
```

### 2. Table 表格配置类
```php
<?php

namespace RedJasmine\Filament{Domain}\Clusters\{ClusterName}\Resources\{Entity}\Tables;

use Filament\Actions\Action;
use Filament\Actions\ActionGroup;
use Filament\Actions\BulkActionGroup;
use Filament\Actions\DeleteAction;
use Filament\Actions\DeleteBulkAction;
use Filament\Actions\EditAction;
use Filament\Actions\ForceDeleteAction;
use Filament\Actions\RestoreAction;
use Filament\Actions\ViewAction;
use Filament\Tables\Columns\TextColumn;
use Filament\Tables\Enums\FiltersLayout;
use Filament\Tables\Filters\SelectFilter;
use Filament\Tables\Table;
use RedJasmine\Filament{Domain}\Clusters\{ClusterName}\Resources\{Entity}\{Entity}Resource;
use RedJasmine\{Domain}\Domain\{Entity}\Models\Enums\{Entity}StatusEnum;

class {Entity}Table
{
    /**
     * 配置表格
     */
    public static function configure(Table $table): Table
    {
        return $table
            ->deferLoading()
            ->columns(static::getColumns())
            ->filters(static::getFilters(), layout: FiltersLayout::AboveContentCollapsible)
            ->deferFilters()
            ->recordUrl(null)
            ->recordActions(static::getRecordActions())
            ->toolbarActions(static::getToolbarActions());
    }

    /**
     * 获取表格列
     */
    protected static function getColumns(): array
    {
        return [
            ...{Entity}Resource::ownerTableColumns(),

            TextColumn::make('id')
                ->label(__('red-jasmine-{domain}::{entity}.fields.id'))
                ->copyable()
                ->sortable()
                ->searchable()
                ->icon('heroicon-o-identification')
                ->color('gray')
                ->size('xs'),

            TextColumn::make('name')
                ->label(__('red-jasmine-{domain}::{entity}.fields.name'))
                ->copyable()
                ->searchable()
                ->limit(30)
                ->weight('bold'),

            TextColumn::make('status')
                ->label(__('red-jasmine-{domain}::{entity}.fields.status'))
                ->badge()
                ->useEnum(),

            // 更多列...
        ];
    }

    /**
     * 获取筛选器
     */
    protected static function getFilters(): array
    {
        return [
            SelectFilter::make('status')
                ->multiple()
                ->label(__('red-jasmine-{domain}::{entity}.fields.status'))
                ->options({Entity}StatusEnum::options()),
        ];
    }

    /**
     * 获取记录操作
     */
    protected static function getRecordActions(): array
    {
        return [
            EditAction::make(),
            ActionGroup::make([
                ViewAction::make(),
                DeleteAction::make(),
            ])
                ->visible(static function ($record): bool {
                    if (method_exists($record, 'trashed')) {
                        return !$record->trashed();
                    }
                    return true;
                }),
            RestoreAction::make(),
            ForceDeleteAction::make(),
        ];
    }

    /**
     * 获取工具栏操作
     */
    protected static function getToolbarActions(): array
    {
        return [
            BulkActionGroup::make([
                DeleteBulkAction::make(),
            ]),
        ];
    }
}
```

## 组件开发规范

### 1. 表单字段组件
```php
<?php

namespace RedJasmine\FilamentCore\Forms\Fields;

use Filament\Forms\Components\Field;

class {ComponentName} extends Field
{
    protected string $view = 'red-jasmine-filament-core::forms.fields.{component-name}';

    protected function setUp(): void
    {
        parent::setUp();

        // 组件初始化逻辑
        $this->afterStateHydrated(function ({ComponentName} $component, $state) {
            // 状态处理逻辑
        });
    }
}
```

### 2. 表格列组件
```php
<?php

namespace RedJasmine\FilamentCore\Columns;

use Filament\Tables\Columns\Column;

class {ComponentName} extends Column
{
    protected string $view = 'red-jasmine-filament-core::columns.{component-name}';

    protected function setUp(): void
    {
        parent::setUp();

        // 列初始化逻辑
    }
}
```

### 3. 过滤器组件
```php
<?php

namespace RedJasmine\FilamentCore\Filters;

use Filament\Tables\Filters\Filter;
use Illuminate\Database\Eloquent\Builder;

class {FilterName} extends Filter
{
    protected function setUp(): void
    {
        parent::setUp();

        $this->form([
            // 表单定义
        ]);

        $this->query(function (Builder $query, array $data): Builder {
            // 查询逻辑
        });
    }
}
```

## 编码规范

### 1. 命名规范
- **类名**: 使用 PascalCase，如 `ArticleResource`
- **方法名**: 使用 camelCase，如 `getModelLabel()`
- **静态属性**: 使用 camelCase，如 `$onlyOwner`
- **常量**: 使用 UPPER_SNAKE_CASE
- **翻译键**: 使用 snake_case，如 `article.labels.title`

### 2. 静态属性规范
```php
// 必需的静态属性
/**
 * @var class-string<{Entity}ApplicationService>
 */
protected static string $service = {Entity}ApplicationService::class;
protected static ?string $createCommand = {Entity}CreateCommand::class;
protected static ?string $updateCommand = {Entity}UpdateCommand::class;
protected static ?string $deleteCommand = {Entity}DeleteCommand::class;
protected static bool $onlyOwner = true;

// Filament 原生属性
protected static ?string $model = {Entity}::class;
protected static ?string $cluster = {ClusterName}::class;
protected static ?int $navigationSort = 1;
protected static string|BackedEnum|null $navigationIcon = 'heroicon-o-document-text';
```

### 3. 方法实现规范
```php
// 模型标签
public static function getModelLabel(): string
{
    return __('red-jasmine-{domain}::{entity}.labels.{entity}');
}

// 查询定制 - 预加载关联数据
public static function callFindQuery(FindQuery $findQuery): FindQuery
{
    $findQuery->include = ['relation1', 'relation2', 'extension'];
    return $findQuery;
}

// 解析记录 - 处理扩展表数据合并
public static function callResolveRecord(Model $model): Model
{
    // 处理扩展表数据合并到主模型
    if ($model->relationLoaded('extension')) {
        foreach ($model->extension->getAttributes() as $key => $value) {
            $model->setAttribute($key, $model->extension->{$key});
        }
    }
    return $model;
}

// 表单配置 - 委托给独立的 Form 类
public static function form(Schema $form): Schema
{
    return {Entity}Form::configure($form);
}

// 表格配置 - 委托给独立的 Table 类
public static function table(Table $table): Table
{
    return {Entity}Table::configure($table);
}
```

### 4. 表单设计规范

#### 使用 Schema 和 Tabs 组织表单
```php
// 在 Form Schema 类中
public static function configure(Schema $form): Schema
{
    $schema = [
        Tab::make('basic_info')
            ->label(__('red-jasmine-{domain}::{entity}.labels.basic_info'))
            ->columns(1)
            ->schema(static::basicInfoFields()),
        Tab::make('other')
            ->label(__('red-jasmine-{domain}::{entity}.labels.other'))
            ->columns(1)
            ->schema(static::otherFields()),
    ];

    return $form
        ->components([
            Tabs::make(__('red-jasmine-{domain}::{entity}.labels.{entity}'))
                ->tabs($schema)
                ->persistTabInQueryString(),
        ])
        ->inlineLabel(true)
        ->columns(1);
}
```

#### 使用 Section 组织字段组
```php
protected static function basicInfoFields(): array
{
    return [
        Owner::make(),

        Section::make('基础信息')
            ->description('设置基本信息')
            ->icon('heroicon-o-information-circle')
            ->columns(2)
            ->schema([
                TextInput::make('name')
                    ->label(__('red-jasmine-{domain}::{entity}.fields.name'))
                    ->required(),
                // 更多字段...
            ]),
    ];
}
```

#### 使用 Operators 组件添加操作者信息
```php
protected static function otherFields(): array
{
    return [
        Section::make('其他设置')
            ->schema([
                // 字段...
            ]),
        Operators::make(), // 操作者信息组件
    ];
}
```

### 5. 表格设计规范

#### 在 Table 配置类中组织表格
```php
public static function configure(Table $table): Table
{
    return $table
        ->deferLoading()  // 延迟加载，提升性能
        ->columns(static::getColumns())
        ->filters(static::getFilters(), layout: FiltersLayout::AboveContentCollapsible)
        ->deferFilters()  // 延迟过滤器
        ->recordUrl(null)  // 禁用默认记录链接
        ->recordActions(static::getRecordActions())
        ->toolbarActions(static::getToolbarActions());
}
```

#### 列定义规范
```php
protected static function getColumns(): array
{
    return [
        // 所有者列
        ...{Entity}Resource::ownerTableColumns(),

        // 基础列
        TextColumn::make('id')
            ->label(__('red-jasmine-{domain}::{entity}.fields.id'))
            ->copyable()
            ->sortable()
            ->searchable()
            ->icon('heroicon-o-identification')
            ->color('gray')
            ->size('xs'),

        TextColumn::make('name')
            ->label(__('red-jasmine-{domain}::{entity}.fields.name'))
            ->copyable()
            ->searchable()
            ->limit(30)
            ->weight('bold'),

        // 枚举列使用 useEnum() 方法
        TextColumn::make('status')
            ->label(__('red-jasmine-{domain}::{entity}.fields.status'))
            ->badge()
            ->useEnum(),

        // 操作列
        ...{Entity}Resource::operateTableColumns(),
    ];
}
```

#### 过滤器定义规范
```php
protected static function getFilters(): array
{
    return [
        SelectFilter::make('status')
            ->multiple()
            ->label(__('red-jasmine-{domain}::{entity}.fields.status'))
            ->options({Entity}StatusEnum::options()),
    ];
}
```

#### 记录操作定义规范
```php
protected static function getRecordActions(): array
{
    return [
        EditAction::make(),
        ActionGroup::make([
            ViewAction::make(),
            DeleteAction::make(),
        ])
            ->visible(static function ($record): bool {
                if (method_exists($record, 'trashed')) {
                    return !$record->trashed();
                }
                return true;
            }),
        RestoreAction::make(),
        ForceDeleteAction::make(),
    ];
}
```

## 国际化规范

### 1. 翻译键结构
```php
// 语言包结构
return [
    'label' => '标签',
    'labels' => [
        'title' => '标题',
        'description' => '描述',
    ],
    'fields' => [
        'id' => 'ID',
        'name' => '名称',
        'status' => '状态',
    ],
    'commands' => [
        'create' => '创建',
        'edit' => '编辑',
        'delete' => '删除',
    ],
];
```

### 2. 使用规范
```php
// 标签使用
->label(__('red-jasmine-{domain}::{entity}.fields.name'))

// 操作使用
->label(__('red-jasmine-{domain}::{entity}.commands.create'))
```
### 3.翻译文件存放在对应的领域包内
- 如 red-jasmine-filament-product，这个是商品领域的管理面板，那么字段、命令、标题的翻译就应该在 red-jasmine-product 内

## 架构集成规范

### 1. 与业务层解耦
- 通过应用服务交互，不直接操作模型
- 使用命令模式处理数据操作
- 使用查询对象处理数据查询

### 2. 权限控制
```php
// 支持多所有者模式
protected static bool $onlyOwner = true;

// 在查询中应用权限
public static function getEloquentQuery(): Builder
{
    $query = app(static::$service)->re->modelQuery();

    if (static::onlyOwner()) {
        $user = auth()->user();
        if (!($user->isAdministrator() ?? false)) {
            $owner = $user instanceof BelongsToOwnerInterface ? $user->owner() : $user;
            $query->onlyOwner($owner);
        }
    }

    return $query;
}
```

### 3. 数据处理
```php
// 创建记录
protected function handleRecordCreation(array $data): Model
{
    $resource = static::getResource();
    $commandService = app($resource::getService());
    $command = ($resource::getCreateCommand())::from($data);

    return $commandService->create($command);
}

// 更新记录
protected function handleRecordUpdate(Model $record, array $data): Model
{
    $resource = static::getResource();
    $commandService = app($resource::getService());
    $command = ($resource::getUpdateCommand())::from($data);
    $command->setKey($record->getKey());

    return $commandService->update($command);
}
```

## 扩展功能规范

### 1. 宏定义
```php
// 在 ServiceProvider 中注册宏
public function packageBooted(): void
{
    // 列宏 - 枚举使用
    Column::macro('useEnum', function () {
        if (method_exists($this, 'badge')) {
            $this->badge();
        }
        if (method_exists($this, 'formatStateUsing')) {
            $this->formatStateUsing(fn($state) => $state->getLabel());
        }
        if (method_exists($this, 'color')) {
            $this->color(fn($state) => $state->getColor());
        }
        return $this;
    });

    // 字段宏 - 枚举使用
    Field::macro('useEnum', function (string $enumClassName) {
        $this->enum($enumClassName);
        if (method_exists($this, 'options')) {
            $this->options($enumClassName::options());
        }
        return $this;
    });
}
```

### 2. 帮助类使用
```php
// 使用 ResourcePageHelper
use RedJasmine\FilamentCore\Helpers\ResourcePageHelper;

class {Entity}Resource extends Resource
{
    use ResourcePageHelper;

    // 自动处理所有者相关逻辑
    // 自动处理操作相关逻辑
}
```

## 测试规范

### 1. 功能测试
```php
public function test_can_list_resources(): void
{
    $this->actingAs($this->user)
         ->get(route('filament.admin.resources.{entities}.index'))
         ->assertSuccessful();
}

public function test_can_create_resource(): void
{
    $this->actingAs($this->user)
         ->post(route('filament.admin.resources.{entities}.store'), [
             'name' => 'Test Name',
             // 其他字段
         ])
         ->assertRedirect();
}
```

### 2. 权限测试
```php
public function test_only_owner_can_access_resources(): void
{
    $otherUser = User::factory()->create();

    $this->actingAs($otherUser)
         ->get(route('filament.admin.resources.{entities}.index'))
         ->assertStatus(403);
}
```

## 性能优化

### 1. 查询优化
```php
// 预加载关联 - 在 Resource 中
public static function callFindQuery(FindQuery $findQuery): FindQuery
{
    $findQuery->include = ['category', 'tags', 'extension'];
    return $findQuery;
}

// 表格查询优化 - 在 Table 配置类中
public static function configure(Table $table): Table
{
    return $table
        ->deferLoading()  // 延迟加载
        ->deferFilters()  // 延迟过滤器
        ->modifyQueryUsing(fn (Builder $query) => $query->with(['category']))
        ->columns(static::getColumns());
}

// 在列定义中避免 N+1 查询
TextColumn::make('category.name')
    ->label(__('red-jasmine-{domain}::{entity}.fields.category'))
    ->badge()
    ->color('info')
```

### 2. 缓存使用
```php
// 选项缓存
Forms\Components\Select::make('category_id')
    ->options(fn () => Cache::remember('categories', 3600, fn () =>
        Category::pluck('name', 'id')
    ));
```

这套规范确保了 Filament 管理界面的一致性、可维护性和扩展性。
