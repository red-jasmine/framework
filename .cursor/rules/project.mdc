---
description: 
globs: 
alwaysApply: true
---
# Red Jasmine Framework 项目规则说明书

## 项目概述

Red Jasmine Framework 是一个基于 Laravel 12.0+ 和 PHP 8.3+ 的现代化电商框架，采用领域驱动设计（DDD）架构，通过模块化的方式构建可扩展的电商系统。

### 技术栈
- **PHP**: 8.3+
- **Laravel**: 12.0+
- **数据库**: MySQL 8.0+
- **缓存**: Redis
- **队列**: Laravel Queue
- **测试**: Pest PHP
- **文档**: VitePress

## 目录结构

### 整体架构
```
framework/
├── packages/                    # 领域包目录
│   ├── support/                # 公共支持包
│   ├── user/                   # 用户领域
│   ├── product/                # 商品领域
│   ├── order/                  # 订单领域
│   ├── payment/                # 支付领域
│   ├── distribution/           # 分销领域
│   ├── wallet/                 # 钱包领域
│   ├── logistics/              # 物流领域
│   ├── interaction/            # 互动领域
│   ├── community/              # 社区领域
│   ├── article/                # 文章领域
│   ├── shopping/               # 购物车领域
│   ├── invitation/             # 邀请领域
│   ├── address/                # 地址领域
│   ├── region/                 # 地区领域
│   ├── captcha/                # 验证码领域
│   ├── socialite/              # 社交登录领域
│   ├── vip/                    # VIP领域
│   ├── resource-usage/         # 资源使用领域
│   ├── ecommerce/              # 电商领域
│   ├── card/                   # 卡券领域
│   ├── admin/                  # 管理后台领域
│   └── filament-*/             # Filament管理面板相关包
├── docs/                       # 文档目录
├── tests/                      # 测试目录
├── workbench/                  # 开发工作台
└── vendor/                     # Composer依赖
```

### 领域包结构
每个领域包都遵循统一的目录结构：

```
packages/{domain}/
├── src/                        # 源代码
│   ├── Domain/                 # 领域层
│   │   ├── Models/             # 领域模型
│   │   │   ├── Enums/          # 枚举定义
│   │   │   └── ValueObjects/   # 值对象
│   │   ├── Repositories/       # 仓库接口
│   │   ├── Data/               # 基础DTO
│   │   ├── Transformers/       # 转换器
│   │   ├── Events/             # 领域事件
│   │   ├── Services/           # 领域服务
│   │   ├── Contracts/          # 领域契约
│   │   └── Facades/            # 门面类
│   ├── Application/            # 应用层
│   │   ├── Commands/           # 命令定义和命令处理器
│   │   ├── Queries/            # 查询定义和查询处理器
│   │   └── Services/           # 应用服务
│   ├── Infrastructure/         # 基础设施层
│   │   ├── Repositories/       # 仓库实现
│   │   │   └── Eloquent/       # Eloquent实现
│   │   └── ReadRepositories/   # 只读仓库实现
│   │       └── Mysql/          # MySQL实现
│   ├── UI/                     # 用户接口层
│   │   └── Http/               # HTTP接口
│   │       ├── Admin/          # 管理员接口
│   │       ├── User/           # 用户接口
│   │       └── Shop/           # 商家接口
│   └── Exceptions/             # 异常处理
├── config/                     # 配置文件
├── database/                   # 数据库相关
│   └── migrations/             # 数据库迁移
├── routes/                     # 路由定义
├── resources/                  # 资源文件
│   ├── lang/                   # 语言文件
│   └── views/                  # 视图文件
├── composer.json               # 包配置
└── README.md                   # 包说明
```

## 公共代码规范

### Support 包核心组件

#### 1. 应用服务基类 (ApplicationService)
```php
/**
 * 应用服务基类，提供标准的CRUD操作和宏扩展能力
 * 
 * 内置方法：
 * - create(Data $command): Model
 * - update(Data $command): Model  
 * - delete(Data $command): bool
 * - find(FindQuery $query): Model
 * - paginate(PaginateQuery $query): LengthAwarePaginator
 */
class ApplicationService
{
    use HasHooks;
    use Macroable;
    
    protected static array $handlers = [
        'create'   => CreateCommandHandler::class,
        'update'   => UpdateCommandHandler::class,
        'delete'   => DeleteCommandHandler::class,
        'find'     => FindQueryHandler::class,
        'paginate' => PaginateQueryHandler::class
    ];
    
    // 自定义宏方法
    protected static array $macros = [];
}
```

#### 2. 仓库接口规范
```php
// 写操作仓库接口
interface RepositoryInterface
{
    public function find($id);
    public function store(Model $model);
    public function update(Model $model);
    public function delete(Model $model);
}

// 读操作仓库接口
interface ReadRepositoryInterface
{
    public function modelQuery(?Query $query = null): Builder;
    public function find(FindQuery $query): ?Model;
    public function paginate(PaginateQuery $query): LengthAwarePaginator|Paginator;
    public function withQuery(Closure $queryCallback): static;
}
```

#### 3. 转换器接口
```php
interface TransformerInterface
{
    public function transform($data, $model): Model;
}
```

## DDD 代码规范

### 领域层 (Domain)

#### 领域模型
#####  规范
- **领域模型**：领域模型采用充血模型策略
- **业务封装**：业务逻辑封装在模型内部
- **逻辑复用**：使用 Trait 复用通用功能
- **事件处理**：支持领域事件分发
- **接口实现**：实现相关接口规范
- **ID生成**：通常雪花ID作为主键，可通过 HasSnowflakeId Trait，设置 public $incrementing = false;
- **所属者信息管理**：支持所属者信息管理
- **审批功能**：有审批需求时才添加审批功能
- **复杂关联**：在 boot 方法中处理复杂的多对多关联同步
- **实例初始化**：重写 newInstance 方法进行模型初始化
- **生命周期钩子**：使用 saving、deleting、restoring 等钩子处理业务逻辑

##### 代码示例
```php
<?php

namespace RedJasmine\Product\Domain\Product\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Collection;
use Illuminate\Database\Eloquent\Relations\BelongsToMany;
use Illuminate\Database\Eloquent\Relations\HasOne;
use Illuminate\Database\Eloquent\SoftDeletes;
use RedJasmine\Product\Domain\Product\Models\Enums\ProductStatusEnum;
use RedJasmine\Product\Domain\Product\Models\Extensions\ProductExtension;
use RedJasmine\Support\Domain\Models\OperatorInterface;
use RedJasmine\Support\Domain\Models\OwnerInterface;
use RedJasmine\Support\Domain\Models\Traits\HasSnowflakeId;
use RedJasmine\Support\Domain\Models\Traits\HasOwner;
use RedJasmine\Support\Domain\Models\Traits\HasOperator;

class Product extends Model implements OperatorInterface, OwnerInterface
{
    use HasSnowflakeId;
    use HasOwner;
    use HasOperator;
    use SoftDeletes;

    public $incrementing = false;

    /**
     * 类型转换配置
     */
    protected function casts(): array
    {
        return [
            'product_type' => ProductTypeEnum::class,
            'status' => ProductStatusEnum::class,
            'is_multiple_spec' => 'boolean',
            'is_brand_new' => 'boolean',
            'price' => MoneyCast::class,
            'market_price' => MoneyCast::class,
            'on_sale_time' => 'datetime',
            'modified_time' => 'datetime',
        ];
    }

    /**
     * 模型生命周期钩子
     */
    protected static function boot(): void
    {
        parent::boot();

        // 保存时处理关联关系
        static::saving(callback: static function (Product $product) {
            // 处理扩展产品分组关联
            if ($product->relationLoaded('extendProductGroups')) {
                if ($product->extendProductGroups?->count() > 0) {
                    if (!is_array($product->extendProductGroups->first())) {
                        $product->extendProductGroups()->sync($product->extendProductGroups);
                    } else {
                        $product->extendProductGroups()->sync($product->extendProductGroups->pluck('id')->toArray());
                    }
                    $product->load('extendProductGroups');
                } else {
                    $product->extendProductGroups()->sync([]);
                }
            }

            // 处理标签关联
            if ($product->relationLoaded('tags')) {
                if ($product->tags?->count() > 0) {
                    $product->tags()->sync($product->tags);
                } else {
                    $product->tags()->sync([]);
                }
                $product->load('tags');
            }
        });

        // 删除时级联处理
        static::deleting(callback: static function (Product $product) {
            $product->extension()->delete();
            $product->skus()->delete();
        });

        // 恢复时级联处理
        static::restoring(callback: static function (Product $product) {
            $product->skus()->withTrashed()->whereNot('status', ProductStatusEnum::DELETED)->restore();
            $product->extension()->withTrashed()->restore();
        });
    }

    /**
     * 新实例初始化
     */
    public function newInstance($attributes = [], $exists = false): static
    {
        $instance = parent::newInstance($attributes, $exists);

        if (!$instance->exists) {
            $instance->setUniqueIds();
            $instance->setRelation('extension', ProductExtension::make());
            $instance->setRelation('skus', Collection::make());
            $instance->setRelation('extendProductGroups', Collection::make());
            $instance->setRelation('tags', Collection::make());
        }

        return $instance;
    }

    /**
     * 关联关系定义
     */
    public function extension(): HasOne
    {
        return $this->hasOne(ProductExtension::class, 'id', 'id');
    }

    public function tags(): BelongsToMany
    {
        return $this->belongsToMany(ProductTag::class, 'product_tag_pivots', 'product_id', 'product_tag_id')
                    ->withTimestamps();
    }

    /**
     * 查询作用域
     */
    public function scopeOnSale(Builder $query)
    {
        return $query->where('status', ProductStatusEnum::ON_SALE);
    }

    public function scopeWarehoused(Builder $query)
    {
        return $query->where('status', ProductStatusEnum::WAREHOUSED);
    }

    /**
     * 业务方法
     */
    public function setStatus(ProductStatusEnum $status): void
    {
        if (!$this->isAllowSetStatus($status)) {
            throw new ProductException('当前状态不允许设置为：' . $status->value);
        }

        $oldStatus = $this->status;
        $this->status = $status;

        // 状态变更时的业务逻辑
        if ($status === ProductStatusEnum::ON_SALE) {
            $this->on_sale_time = Carbon::now();
        }
    }

    public function isAllowSale(): bool
    {
        return $this->status === ProductStatusEnum::ON_SALE 
            && $this->stock > 0;
    }
}
```


#### 枚举值
- **逻辑复用**：使用  RedJasmine\Support\Helpers\Enums\EnumsHelper Trait 复用通用功能
- **其他**： 补充 labels,colors,icons 方法的配置

##### 代码示例
```php
namespace RedJasmine\Article\Domain\Models\Enums;

use RedJasmine\Support\Helpers\Enums\EnumsHelper;

enum TagStatusEnum: string
{

    use EnumsHelper;

    case DISABLE = 'disable';


    case ENABLE = 'enable';

    /**
     * @return array
     */
    public static function labels() : array
    {
        return [
            self::ENABLE->value  => __('red-jasmine-article::article-tag.enums.status.disable'),
            self::DISABLE->value => __('red-jasmine-article::article-tag.enums.status.enable'),
        ];

    }


    public static function colors() : array
    {
        return [
            self::ENABLE->value  => 'success',
            self::DISABLE->value => 'danger',
        ];

    }

    public static function icons() : array
    {
        return [
            self::ENABLE->value  => 'heroicon-o-check-circle',
            self::DISABLE->value => 'heroicon-o-no-symbol',
        ];
    }
}
```

#### 值对象 (ValueObjects)
##### 规范
- **基类继承**：继承 `RedJasmine\Support\Domain\Models\ValueObjects\ValueObject`
- **不可变性**：值对象应该是不可变的，所有属性都是只读的
- **类型安全**：使用强类型声明和PHPDoc注释
- **命名规范**：值对象名格式为具体业务概念名称
- **业务表达**：值对象应该表达特定的业务概念

##### 代码示例
```php
<?php

namespace RedJasmine\Product\Domain\Product\Models\ValueObjects;

use Illuminate\Support\Collection;
use RedJasmine\Support\Domain\Models\ValueObjects\ValueObject;

class Property extends ValueObject
{
    /**
     * 属性ID
     * @var int
     */
    public int $pid;

    /**
     * 名称
     * @var string
     */
    public string $name;

    /**
     * 单位
     * @var string|null
     */
    public ?string $unit;
    
    /**
     * 属性值
     * @var Collection<PropValue>
     */
    public Collection $values;
}
```

#### 领域服务 (Domain Services)
##### 规范
- **职责明确**：处理不属于任何实体或值对象的业务逻辑
- **无状态性**：领域服务应该是无状态的
- **业务聚焦**：专注于特定的业务逻辑处理
- **命名规范**：服务名格式为 `{业务概念}{Service/Formatter/Calculator}`
- **方法设计**：方法应该表达明确的业务意图

##### 代码示例
```php
<?php

namespace RedJasmine\Product\Domain\Product;

use RedJasmine\Product\Exceptions\ProductPropertyException;

class PropertyFormatter
{
    /**
     * 转换规格名称
     *
     * @param array $labels
     * @return string
     */
    public function toNameString(array $labels): string
    {
        $labelString = [];
        foreach ($labels as $label) {
            $labelString[] = implode(':', [
                $label['name'], 
                filled($label['alias'] ?? '') ? $label['alias'] : $label['value']
            ]);
        }

        return implode(';', $labelString);
    }

    /**
     * 属性笛卡尔积
     *
     * @param array{pid:int,vid:int|int[]} $props
     * @return string[]
     */
    public function crossJoinToString(array $props = []): array
    {
        $crossJoin = $this->crossJoinToArray($props);
        $crossJoinTextList = [];
        foreach ($crossJoin as $item) {
            $crossJoinTextList[] = $this->toString($item);
        }
        return $crossJoinTextList;
    }
}
```

#### 自定义类型转换器 (Custom Casts)
##### 规范
- **接口实现**：实现 `Illuminate\Contracts\Database\Eloquent\CastsAttributes` 接口
- **命名规范**：转换器名格式为 `{属性名}Cast`
- **类型安全**：确保类型转换的安全性和正确性
- **双向转换**：实现 `get` 和 `set` 方法进行双向转换
- **异常处理**：处理转换过程中可能出现的异常

##### 代码示例
```php
<?php

namespace RedJasmine\Product\Domain\Product\Casts;

use Illuminate\Contracts\Database\Eloquent\CastsAttributes;
use Illuminate\Database\Eloquent\Model;

class SalePropsCast implements CastsAttributes
{
    public function get(Model $model, string $key, mixed $value, array $attributes)
    {
        // 实现从数据库到应用的转换逻辑
        return json_decode($value, true);
    }

    public function set(Model $model, string $key, mixed $value, array $attributes)
    {
        // 实现从应用到数据库的转换逻辑
        return json_encode($value);
    }
}
```

#### 领域仓库接口
##### 规范
- **接口继承**：继承 `RedJasmine\Support\Domain\Repositories\RepositoryInterface`
- **方法注释**：使用 PHPDoc 注释指定返回类型
- **命名规范**：接口名格式为 `{Entity}RepositoryInterface`
- **职责单一**：每个仓库接口只负责一个聚合根的写操作

##### 代码示例
```php
<?php

namespace RedJasmine\Article\Domain\Repositories;

use RedJasmine\Article\Domain\Models\Article;
use RedJasmine\Support\Domain\Repositories\RepositoryInterface;

/**
 * @method Article find($id)
 */
interface ArticleRepositoryInterface extends RepositoryInterface
{
    // 可添加特定的写操作方法
}
```

#### 领域只读仓库接口
##### 规范
- **接口继承**：继承 `RedJasmine\Support\Domain\Repositories\ReadRepositoryInterface`
- **命名规范**：接口名格式为 `{Entity}ReadRepositoryInterface`
- **职责分离**：只负责数据查询，不涉及写操作

##### 代码示例
```php
<?php

namespace RedJasmine\Article\Domain\Repositories;

use RedJasmine\Support\Domain\Repositories\ReadRepositoryInterface;

interface ArticleReadRepositoryInterface extends ReadRepositoryInterface
{
    // 可添加特定的查询方法
}
```

#### 数据传输对象 (DTO)
##### 规范
- **基类继承**：继承 `RedJasmine\Support\Data\Data`
- **属性类型**：使用强类型声明，支持 PHP 8.3+ 类型系统
- **枚举转换**：使用 `#[WithCast(EnumCast::class)]` 属性进行枚举转换
- **命名规范**：DTO名格式为 `{Entity}Data`
- **初始化值**：为属性提供合理的默认值
- **用户类型属性**：使用 RedJasmine\Support\Contracts\UserInterface 作为属性类型

##### 代码示例
```php
<?php

namespace RedJasmine\Article\Domain\Data;

use RedJasmine\Support\Contracts\UserInterface;
use RedJasmine\Support\Data\Data;
use RedJasmine\Support\Domain\Models\Enums\ContentTypeEnum;
use Spatie\LaravelData\Attributes\WithCast;
use Spatie\LaravelData\Casts\EnumCast;

class ArticleData extends Data
{
    public UserInterface $owner;

    public string $title;

    #[WithCast(EnumCast::class, ContentTypeEnum::class)]
    public ContentTypeEnum $contentType = ContentTypeEnum::RICH;

    public string $content;

    public ?string $image = null;

    public ?string $description = null;

    public ?string $keywords = null;

    public ?int $categoryId = null;

    public int $sort = 0;

    public bool $isShow = false;

    public array $tags = [];
}
```

#### 复杂业务DTO
##### 规范
- **业务完整性**：DTO应包含完整的业务属性
- **默认值策略**：为业务属性提供合理的默认值
- **集合属性**：使用 Collection 或 array 类型处理集合数据
- **值对象集成**：可包含值对象类型的属性
- **构造函数初始化**：在构造函数中进行复杂的初始化逻辑
- **静态工厂方法**：提供静态方法生成默认配置

##### 代码示例
```php
<?php

namespace RedJasmine\Product\Domain\Product\Data;

use Illuminate\Support\Collection;
use RedJasmine\Ecommerce\Domain\Models\Enums\ProductTypeEnum;
use RedJasmine\Product\Domain\Product\Models\Enums\ProductStatusEnum;
use RedJasmine\Product\Domain\Product\Models\ValueObjects\Medium;
use RedJasmine\Support\Contracts\UserInterface;
use RedJasmine\Support\Data\Data;

/**
 * 产品数据类
 * 该类用于表示产品的各种属性和信息
 */
class Product extends Data
{
    // 基础信息
    public string $market = 'default';
    public ProductTypeEnum $productType;
    public UserInterface $owner;
    public string $title;
    public ?string $slogan;

    // 状态和配置
    public ProductStatusEnum $status = ProductStatusEnum::ON_SALE;
    public FreightPayerEnum $freightPayer = FreightPayerEnum::SELLER;
    public SubStockTypeEnum $subStock = SubStockTypeEnum::DEFAULT;

    // 布尔属性
    public bool $isAloneOrder = false;
    public bool $isPreSale = false;
    public bool $isBrandNew = false;
    public bool $isMultipleSpec = false;
    public bool $isCustomized = false;

    // 数值属性
    public int $unitQuantity = 1;
    public int $deliveryTime = 0;
    public ?int $sort = 0;
    public int $stepLimit = 1;
    public int $giftPoint = 0;

    // ID关联
    public int $categoryId = 0;
    public int $brandId = 0;
    public int $productGroupId = 0;

    // 集合属性
    public array $deliveryMethods = [];
    public array $extendProductGroups = [];
    public array $tags = [];
    public array $services = [];

    // 可选属性
    public ?string $image = null;
    public ?string $barcode = null;
    public ?string $outerId = null;
    public ?string $unit = null;
    public ?string $productModel = null;
    public ?int $freightTemplateId = null;

    // 限制属性
    public ?int $minLimit = 0;
    public ?int $maxLimit = 0;
    public OrderQuantityLimitTypeEnum $orderQuantityLimitType = OrderQuantityLimitTypeEnum::UNLIMITED;
    public ?int $orderQuantityLimitNum = null;

    // 供应商相关
    public bool $isFromSupplier = false;
    public ?UserInterface $supplier;
    public ?int $supplierProductId = null;

    // 内容属性
    public ?string $tips = null;
    public ?string $keywords = null;
    public ?string $description = null;
    public ?string $detail = null;

    // 媒体资源
    /** @var Medium[]|null */
    public ?array $images = null;
    /** @var Medium[]|null */
    public ?array $videos = null;

    // 售后服务
    /** @var AfterSalesService[] */
    public array $afterSalesServices = [];

    // 基础属性
    /** @var Collection<Property>|null */
    public ?Collection $properties = null;

    // 扩展属性
    public ?array $tools;
    public ?array $extra;
    public ?string $remarks;

    public function __construct()
    {
        $this->afterSalesServices = static::defaultAfterSalesServices();
    }

    public static function defaultAfterSalesServices(): array
    {
        return [
            // 默认售后服务配置
        ];
    }
}
```

#### 领域转换器
##### 规范
- **接口实现**：实现 `RedJasmine\Support\Domain\Transformer\TransformerInterface`
- **方法定义**：`transform($data, $model): Model`
- **命名规范**：转换器名格式为 `{Entity}Transformer`
- **数据映射**：负责将DTO数据映射到领域模型
- **关联处理**：处理模型关联关系的设置

##### 代码示例
```php
<?php

namespace RedJasmine\Article\Domain\Transformer;

use Illuminate\Database\Eloquent\Model;
use RedJasmine\Article\Domain\Data\ArticleData;
use RedJasmine\Article\Domain\Models\Article;
use RedJasmine\Support\Domain\Transformer\TransformerInterface;

class ArticleTransformer implements TransformerInterface
{
    /**
     * @param ArticleData $data
     * @param Article $model
     * @return Article
     */
    public function transform($data, $model): Article
    {
        $model->title = $data->title;
        $model->image = $data->image;
        $model->description = $data->description;
        $model->keywords = $data->keywords;
        $model->category_id = $data->categoryId ?? $model->category_id;
        $model->sort = $data->sort;
        $model->is_show = $data->isShow;
        $model->extension->content_type = $data->contentType;
        $model->extension->content = $data->content;
        $model->setRelation('tags', collect($data->tags));

        return $model;
    }
}
```

### 应用层 (Application)

#### 应用服务
##### 规范
- **基类继承**：继承 `RedJasmine\Support\Application\ApplicationService`
- **依赖注入**：通过构造函数注入仓库和转换器，使用 public 可见性
- **静态属性**：定义 `$modelClass`、`$macros` 和 `$hookNamePrefix`
- **命名规范**：服务名格式为 `{Entity}ApplicationService`
- **宏扩展**：使用 `$macros` 数组扩展自定义方法
- **Hook机制**：使用 hook 方法实现扩展点管理
- **PHPDoc注解**：使用 `@see` 和 `@method` 进行详细说明
- **默认信息**：实现 `getDefaultModelWithInfo()` 方法配置默认加载关联

##### 代码示例
```php
<?php

namespace RedJasmine\Product\Application\Product\Services;

use RedJasmine\Product\Domain\Product\Models\Product;
use RedJasmine\Product\Domain\Product\Repositories\ProductReadRepositoryInterface;
use RedJasmine\Product\Domain\Product\Repositories\ProductRepositoryInterface;
use RedJasmine\Support\Application\ApplicationService;

/**
 * 产品应用服务
 * 
 * 负责处理产品相关的业务逻辑，包括：
 * - 产品创建
 * - 产品更新
 * - 状态管理
 * 
 * @see ProductCreateCommandHandler::handle()
 * @method Product create(ProductCreateCommand $command)
 * @see ProductUpdateCommandHandler::handle()
 * @method void update(ProductUpdateCommand $command)
 * @method void setStatus(ProductSetStatusCommand $command)
 */
class ProductApplicationService extends ApplicationService
{
    /**
     * Hook前缀配置
     * @var string
     */
    public static string $hookNamePrefix = 'product.application.product';

    protected static string $modelClass = Product::class;

    public function __construct(
        public ProductRepositoryInterface $repository,
        public ProductReadRepositoryInterface $readRepository
    ) {
    }

    public function getDefaultModelWithInfo(): array
    {
        return ['extension', 'tags'];
    }

    protected static $macros = [
        'create'    => ProductCreateCommandHandler::class,
        'update'    => ProductUpdateCommandHandler::class,
        'delete'    => ProductDeleteCommandHandler::class,
        'setStatus' => ProductSetStatusCommandHandler::class,
    ];
}
```

#### 命令处理器
##### 规范
- **基类继承**：继承 `RedJasmine\Support\Application\Commands\CommandHandler`
- **依赖注入**：通过构造函数注入应用服务
- **事务处理**：使用数据库事务确保数据一致性
- **异常处理**：捕获并重新抛出异常，确保事务回滚
- **命名规范**：处理器名格式为 `{Action}CommandHandler`

##### 代码示例
```php
<?php

namespace RedJasmine\Article\Application\Services\Article\Commands;

use RedJasmine\Article\Application\Services\Article\ArticleApplicationService;
use RedJasmine\Support\Application\Commands\CommandHandler;
use RedJasmine\Support\Exceptions\AbstractException;
use Throwable;

class ArticlePublishCommandHandler extends CommandHandler
{
    public function __construct(
        protected ArticleApplicationService $service
    ) {
    }

    /**
     * @param ArticlePublishCommand $command
     * @return bool
     * @throws AbstractException
     * @throws Throwable
     */
    public function handle(ArticlePublishCommand $command): bool
    {
        $this->beginDatabaseTransaction();

        try {
            $model = $this->service->repository->find($command->getKey());
            $model->publish();
            $this->service->repository->update($model);
            
            $this->commitDatabaseTransaction();
        } catch (AbstractException $exception) {
            $this->rollBackDatabaseTransaction();
            throw $exception;
        } catch (Throwable $throwable) {
            $this->rollBackDatabaseTransaction();
            throw $throwable;
        }

        return true;
    }
}
```

#### 查询处理器
##### 规范
- **基类继承**：继承 `RedJasmine\Support\Application\Queries\QueryHandler`
- **只读操作**：只进行数据查询，不进行写操作
- **分页支持**：支持分页查询功能
- **过滤器**：提供灵活的查询过滤器
- **命名规范**：处理器名格式为 `{Action}QueryHandler`

#### 命令处理器基类
##### 规范
- **基类继承**：继承 `RedJasmine\Support\Application\Commands\CommandHandler`
- **共享逻辑**：提供子类共用的验证和处理逻辑
- **依赖注入**：注入相关的应用服务和领域服务
- **命名规范**：基类名格式为 `{Entity}CommandHandler`
- **验证方法**：提供统一的验证方法
- **事务处理**：统一事务管理逻辑

##### 代码示例
```php
<?php

namespace RedJasmine\Product\Application\Product\Services\Commands;

use RedJasmine\Product\Application\Product\Services\ProductApplicationService;
use RedJasmine\Product\Domain\Product\PropertyFormatter;
use RedJasmine\Product\Domain\Product\Transformer\ProductTransformer;
use RedJasmine\Product\Exceptions\ProductException;
use RedJasmine\Support\Application\Commands\CommandHandler;
use Throwable;

/**
 * 产品命令处理器基类
 * 
 * @method ProductApplicationService getService()
 */
class ProductCommandHandler extends CommandHandler
{
    public function __construct(
        public ProductApplicationService $service,
        protected BrandApplicationService $brandQueryService,
        protected StockCommandService $stockCommandService,
        protected PropertyFormatter $propertyFormatter,
        protected PropertyValidateService $propertyValidateService,
        protected ProductCategoryApplicationService $categoryQueryService,
        protected ProductGroupApplicationService $groupQueryService,
        protected ProductTransformer $productTransformer
    ) {
    }

    /**
     * 统一验证逻辑
     *
     * @param \RedJasmine\Product\Domain\Product\Data\Product $command
     * @return void
     * @throws ProductException
     */
    protected function validate(\RedJasmine\Product\Domain\Product\Data\Product $command): void
    {
        $this->validateBrand($command);
        $this->validateCategory($command);
        $this->validateSellerCategory($command);
    }

    /**
     * 品牌验证
     *
     * @param \RedJasmine\Product\Domain\Product\Data\Product $command
     * @return void
     * @throws ProductException
     */
    protected function validateBrand(\RedJasmine\Product\Domain\Product\Data\Product $command): void
    {
        try {
            if ($command->brandId && !$this->brandQueryService->isAllowUse($command->brandId)) {
                throw new ProductException('品牌不可使用');
            }
        } catch (Throwable $exception) {
            throw new ProductException('品牌不可使用');
        }
    }

    /**
     * 库存处理逻辑
     *
     * @param Product $product
     * @param \RedJasmine\Product\Domain\Product\Data\Product $command
     * @return void
     * @throws Throwable
     */
    protected function handleStock(Product $product, \RedJasmine\Product\Domain\Product\Data\Product $command): void
    {
        $skuCommand = $command->skus?->keyBy('properties');

        foreach ($product->skus as $sku) {
            $stock = $sku->deleted_at ? 0 : ($skuCommand[$sku->properties]?->stock ?? $command->stock);

            $stockCommand = new StockCommand();
            $stockCommand->productId = $sku->product_id;
            $stockCommand->actionType = ProductStockActionTypeEnum::RESET;
            $stockCommand->skuId = $sku->id;
            $stockCommand->actionStock = $stock;
            $stockCommand->changeType = ProductStockChangeTypeEnum::SELLER;

            $this->stockCommandService->reset($stockCommand);
        }
    }
}
```

### 基础设施层 (Infrastructure)

#### 仓库实现 (Eloquent)
##### 规范
- **基类继承**：继承 `RedJasmine\Support\Infrastructure\Repositories\Eloquent\EloquentRepository`
- **接口实现**：实现对应的领域仓库接口
- **静态属性**：定义 `$eloquentModelClass` 指定Eloquent模型
- **命名规范**：实现类名格式为 `{Entity}Repository`
- **职责专一**：只负责写操作的具体实现

##### 代码示例
```php
<?php

namespace RedJasmine\Article\Infrastructure\Repositories\Eloquent;

use RedJasmine\Article\Domain\Models\Article;
use RedJasmine\Article\Domain\Repositories\ArticleRepositoryInterface;
use RedJasmine\Support\Infrastructure\Repositories\Eloquent\EloquentRepository;

class ArticleRepository extends EloquentRepository implements ArticleRepositoryInterface
{
    protected static string $eloquentModelClass = Article::class;
}
```

#### 只读仓库实现 (MySQL)
##### 规范
- **基类继承**：继承 `RedJasmine\Support\Infrastructure\ReadRepositories\QueryBuilderReadRepository`
- **接口实现**：实现对应的领域只读仓库接口
- **静态属性**：定义 `$modelClass` 指定模型类
- **过滤器配置**：实现 `allowedFilters()` 方法配置查询过滤器
- **排序配置**：实现 `allowedSorts()` 方法配置允许的排序字段
- **包含关联**：实现 `allowedIncludes()` 方法配置可包含的关联
- **自定义查询**：可添加特定的查询方法，如 `findList()`
- **命名规范**：实现类名格式为 `{Entity}ReadRepository`

##### 代码示例
```php
<?php

namespace RedJasmine\Product\Infrastructure\ReadRepositories\Mysql;

use RedJasmine\Product\Domain\Product\Models\Product;
use RedJasmine\Product\Domain\Product\Repositories\ProductReadRepositoryInterface;
use RedJasmine\Support\Infrastructure\ReadRepositories\QueryBuilderReadRepository;
use Spatie\QueryBuilder\AllowedFilter;
use Spatie\QueryBuilder\AllowedSort;

class ProductReadRepository extends QueryBuilderReadRepository implements ProductReadRepositoryInterface
{
    public static $modelClass = Product::class;

    /**
     * 批量查询
     *
     * @param array $ids
     * @return Product[]
     */
    public function findList(array $ids)
    {
        return $this->query()->whereIn('id', $ids)->get();
    }

    /**
     * 允许的排序字段配置
     */
    public function allowedSorts(): array
    {
        return [
            AllowedSort::field('price'),
            AllowedSort::field('cost_price'),
            AllowedSort::field('market_price'),
            AllowedSort::field('sales'),
            AllowedSort::field('stock'),
            AllowedSort::field('on_sale_time'),
            AllowedSort::field('modified_time'),
        ];
    }

    /**
     * 允许的过滤器配置
     */
    public function allowedFilters(): array
    {
        return [
            AllowedFilter::partial('title'),
            AllowedFilter::exact('id'),
            AllowedFilter::exact('market'),
            AllowedFilter::exact('owner_type'),
            AllowedFilter::exact('owner_id'),
            AllowedFilter::exact('product_type'),
            AllowedFilter::exact('status'),
            AllowedFilter::exact('brand_id'),
            AllowedFilter::exact('category_id'),
            AllowedFilter::exact('product_group_id'),
            AllowedFilter::exact('barcode'),
            AllowedFilter::exact('product_model'),
        ];
    }

    /**
     * 允许包含的关联配置
     */
    public function allowedIncludes(): array
    {
        return [
            'extension',
            'services',
            'skus',
            'brand',
            'category',
            'productGroups',
            'extendProductGroups',
            'series',
            'tags',
        ];
    }
}
```

### 用户接口层 (UI)

#### 控制器
##### 规范
- **基类继承**：继承适当的基础控制器类
- **RestfulActions**：使用 `RestControllerActions` Trait 提供标准CRUD操作
- **静态属性配置**：定义资源类、查询类、模型类和数据类
- **依赖注入**：通过构造函数注入应用服务
- **权限控制**：实现 `authorize()` 方法进行权限验证
- **查询作用域**：在构造函数中设置查询作用域
- **命名规范**：控制器名格式为 `{Entity}Controller`

##### 代码示例
```php
<?php

namespace RedJasmine\Article\UI\Http\Admin\Api\Controllers;

use RedJasmine\Article\Application\Services\Article\ArticleApplicationService;
use RedJasmine\Article\Application\Services\Article\Queries\PaginateQuery;
use RedJasmine\Article\Domain\Data\ArticleData as Data;
use RedJasmine\Article\Domain\Models\Article as Model;
use RedJasmine\Article\UI\Http\User\Api\Resources\ArticleResource as Resource;
use RedJasmine\Support\UI\Http\Controllers\RestControllerActions;

class ArticleController extends Controller
{
    protected static string $resourceClass      = Resource::class;
    protected static string $paginateQueryClass = PaginateQuery::class;
    protected static string $modelClass         = Model::class;
    protected static string $dataClass          = Data::class;

    use RestControllerActions;

    public function __construct(
        protected ArticleApplicationService $service,
    ) {
        $this->service->readRepository->withQuery(function ($query) {
            $query->onlyOwner($this->getOwner());
        });
    }

    public function authorize($ability, $arguments = []): bool
    {
        return true;
    }
}
```

#### API资源
##### 规范
- **基类继承**：继承 `JsonResource` 或框架提供的基础资源类
- **数据转换**：将模型数据转换为API响应格式
- **关联加载**：合理处理关联数据的加载和展示
- **条件字段**：根据条件显示不同的字段
- **命名规范**：资源类名格式为 `{Entity}Resource`

#### 请求验证
##### 规范
- **基类继承**：继承 `FormRequest` 或框架提供的基础请求类
- **验证规则**：定义 `rules()` 方法返回验证规则
- **错误消息**：定义 `messages()` 方法返回自定义错误消息
- **数据准备**：实现 `prepareForValidation()` 方法准备验证数据
- **命名规范**：请求类名格式为 `{Action}{Entity}Request`

## 异常处理规范

### 领域异常
#### 规范
- **基类继承**：继承 `RedJasmine\Support\Exceptions\AbstractException`
- **命名规范**：异常类名格式为 `{Entity}Exception`
- **错误码**：定义明确的错误码
- **错误消息**：提供清晰的错误描述
- **语言支持**：支持多语言错误消息

#### 代码示例
```php
<?php

namespace RedJasmine\Article\Exceptions;

use RedJasmine\Support\Exceptions\AbstractException;

class ArticleException extends AbstractException
{
    // 可添加特定的异常处理逻辑
}
```


## 文档规范

### 1. 文档结构要求

#### 目录结构规范
```
docs/
├── {domain}/                    # 领域文档目录
│   ├── index.md                # 领域介绍文档（必需）
│   ├── storage.md              # 存储层设计文档（必需）
│   ├── {submodule}/            # 子模块文档目录
│   │   ├── index.md            # 子模块介绍（必需）
│   │   ├── model.puml          # 领域模型UML（必需）
│   │   ├── events.puml         # 领域事件UML（可选）
│   │   ├── sequence.puml       # 时序图UML（可选）
│   │   └── rules.md            # 核心规则说明（可选）
│   ├── *.puml                  # 领域级UML图（可选）
│   └── assets/                 # 静态资源目录（可选）
│       ├── images/             # 图片资源
│       └── diagrams/           # 图表资源
```

#### 文件命名规范
- **领域目录**：使用英文小写，如 `distribution`、`payment`、`user`
- **子模块目录**：使用英文小写，如 `promoter`、`order`、`wallet`
- **UML文件**：使用英文小写，如 `model.puml`、`events.puml`
- **Markdown文件**：使用英文小写，如 `index.md`、`storage.md`

### 2. 文档格式规范

#### 2.1 文档头部配置规则
- **必需配置项**：
  - `title`：文档标题，使用中文
  - `description`：文档描述，简要说明文档内容
  - `outline`：大纲深度，设置为 `deep`
  - `order`：文档排序，使用数字
- **可选配置项**：
  - `lastUpdated`：最后更新时间，设置为 `true`
  - `tags`：文档标签，用于分类
  - `author`：文档作者

#### 2.2 概述部分规则
- **概述内容**：必须包含领域的基本情况、主要职责、业务价值
- **问题域**：列出领域要解决的核心问题
- **业务价值**：说明领域为业务带来的价值
- **语言要求**：使用清晰、准确的中文描述

#### 2.3 核心能力描述规则
- **分类要求**：按功能模块分类描述核心能力
- **描述格式**：每个能力包含功能名称和具体说明
- **数量要求**：核心能力数量控制在3-6个
- **重点突出**：突出领域最核心、最重要的功能

#### 2.4 领域参与角色规则
- **分类要求**：必须区分内部角色和外部角色
- **角色描述**：每个角色必须说明职责和权限
- **角色数量**：内部角色控制在4-6个，外部角色控制在3-5个
- **命名规范**：角色名称使用中文，职责描述清晰明确

#### 2.5 连接领域规则
- **分类要求**：必须区分上游领域和下游领域
- **依赖说明**：说明与每个连接领域的依赖关系
- **接口描述**：简要说明与连接领域的接口
- **数量控制**：上下游领域各控制在3-5个

#### 2.6 核心用例规则
- **用例格式**：使用标准用例格式，包含参与者、前置条件、主流程、后置条件
- **用例编号**：使用UC001、UC002等格式编号
- **用例数量**：核心用例控制在3-5个
- **流程描述**：主流程使用步骤列表，步骤清晰明确

#### 2.7 统一语言表规则
- **表格结构**：必须包含英文名称、中文名称、说明、示例四列
- **术语数量**：控制在30个以内核心术语
- **命名规范**：英文名称使用PascalCase，中文名称简洁明了
- **示例要求**：每个术语必须提供使用示例

#### 2.8 领域模型规则
- **UML引用**：必须通过include方式引用UML文件
- **模型说明**：必须提供核心实体的说明
- **实体数量**：核心实体控制在5-8个
- **关系描述**：说明实体间的主要关系

### 3. UML 规范

#### 3.1 命名规范
- **类名**：必须使用中文，如 `分销员`、`佣金`、`推广订单`
- **属性名**：必须使用中文，如 `用户ID`、`佣金金额-CommissionAmount`