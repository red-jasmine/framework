# 电商活动

## 概述

电商活动是电商平台促进销售、增加用户参与度的重要手段。本系统需要支持多种类型的营销活动，包括但不限于秒杀、拼团、砍价、折扣、满减、凑单等，以满足不同业务场景的需求。

## 核心模型

### 电商活动
- 类型: 秒杀、拼团、砍价、折扣、满减、凑单
- 发起方：平台、商家
- 活动时间: 报名时间、活动时间（开始时间、结束时间）
- 商品报名要求：价格限制、库存要求、品类限制等
- 店铺报名要求：信誉等级、经营类目、服务质量等
- 用户参与要求：新用户专享、会员等级、地域限制等
- 活动规则：参与次数限制、限购数量、优惠叠加规则等
- 状态管理：待开始、进行中、已结束、已取消

### 业务逻辑
- 发起活动：创建活动、设置规则、审核机制
- 商家报名：提交商品、设置活动价、锁定库存
- 用户参与：浏览活动、选择商品、下单购买
- 活动管理：活动监控、数据统计、异常处理

### 参与商品
- 商品信息: 原价、活动价、活动库存
- 参与时间段：商品在活动中的生效时间
- 库存管理：活动库存扣减、库存回滚机制
- 限购设置：单用户限购数量、总限购数量

## 扩展功能

### 活动推广
- 分享机制：社交分享、邀请奖励
- 消息推送：活动提醒、进度通知
- 广告投放：首页展示、搜索推荐

### 数据统计
- 销售数据：参与商品数、订单数、销售额
- 用户行为：浏览量、参与人数、转化率
- 效果分析：活动ROI、用户画像、复购率

### 风险控制
- 防刷机制：频率限制、身份验证
- 异常监控：订单异常、价格异常、库存异常
- 客诉处理：退款处理、争议解决

## 存储层数据库表设计

### 1. 电商活动主表 (promotion_activities)

```sql
CREATE TABLE `promotion_activities` (
  `id` bigint(20) unsigned NOT NULL COMMENT '活动ID',
  `title` varchar(255) NOT NULL COMMENT '活动标题',
  `description` text COMMENT '活动描述',
  `type` varchar(50) NOT NULL COMMENT '活动类型 (flash_sale, group_buying, bargain, discount, full_reduction, bundle)',
  `owner_type` varchar(64) NOT NULL COMMENT '发起方类型 (platform, merchant)',
  `owner_id` varchar(64) NOT NULL COMMENT '发起方ID',
  
  -- 活动时间
  `sign_up_start_time` datetime COMMENT '报名开始时间',
  `sign_up_end_time` datetime COMMENT '报名结束时间',
  `start_time` datetime NOT NULL COMMENT '活动开始时间',
  `end_time` datetime NOT NULL COMMENT '活动结束时间',
  
  -- 活动要求
  `product_requirements` json COMMENT '商品报名要求',
  `shop_requirements` json COMMENT '店铺报名要求',
  `user_requirements` json COMMENT '用户参与要求',
  
  -- 活动规则
  `rules` json COMMENT '活动规则',
  `overlay_rules` json COMMENT '优惠叠加规则',
  
  -- 状态管理
  `status` varchar(32) NOT NULL DEFAULT 'draft' COMMENT '活动状态 (draft, pending, published, warming, running, paused, ended, cancelled)',
  `is_show` tinyint(1) DEFAULT 1 COMMENT '是否展示',
  
  -- 数据统计
  `total_products` int DEFAULT 0 COMMENT '参与商品总数',
  `total_orders` int DEFAULT 0 COMMENT '总订单数',
  `total_sales` decimal(12,2) DEFAULT 0.00 COMMENT '总销售额',
  `total_participants` int DEFAULT 0 COMMENT '总参与人数',
  
  -- 操作信息
  `version` bigint(20) unsigned DEFAULT 0 COMMENT '版本号',
  `creator_type` varchar(64) COMMENT '创建者类型',
  `creator_id` varchar(64) COMMENT '创建者ID',
  `creator_name` varchar(255) COMMENT '创建者名称',
  `updater_type` varchar(64) COMMENT '更新者类型',
  `updater_id` varchar(64) COMMENT '更新者ID',
  `updater_name` varchar(255) COMMENT '更新者名称',
  `created_at` timestamp NULL DEFAULT NULL COMMENT '创建时间',
  `updated_at` timestamp NULL DEFAULT NULL COMMENT '更新时间',
  `deleted_at` timestamp NULL DEFAULT NULL COMMENT '删除时间',
  
  PRIMARY KEY (`id`),
  KEY `idx_creator` (`creator_type`, `creator_id`),
  KEY `idx_time` (`start_time`, `end_time`),
  KEY `idx_status` (`status`),
  KEY `idx_type` (`type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='电商活动表';
```

### 2. 活动商品表 (promotion_activity_products)

```sql
CREATE TABLE `promotion_activity_products` (
  `id` bigint(20) unsigned NOT NULL COMMENT 'ID',
  `activity_id` bigint(20) unsigned NOT NULL COMMENT '活动ID',
  `product_id` bigint(20) unsigned NOT NULL COMMENT '商品ID',
  `seller_type` varchar(64) NOT NULL COMMENT '卖家类型',
  `seller_id` varchar(64) NOT NULL COMMENT '卖家ID',

  
  -- 商品信息
  `title` varchar(255) NOT NULL COMMENT '商品标题',
  `image` varchar(500) COMMENT '商品主图',
  `original_price` decimal(10,2) NOT NULL COMMENT '原价',
  `sales` bigint(20) DEFAULT 0 COMMENT '商品销量',
  
  -- 活动设置 (统一设置模式)
  `activity_price` decimal(10,2) COMMENT '统一活动价',
  `discount_rate` decimal(5,2) COMMENT '统一折扣率',
  `activity_stock` int COMMENT '统一活动库存',
  `locked_stock` int DEFAULT 0 COMMENT '已锁定库存',
  `user_purchase_limit` int COMMENT '单用户限购数量',
  
  -- 参与模式
  `sku_participation_mode` varchar(32) NOT NULL DEFAULT 'all_skus' COMMENT 'SKU参与模式 (all_skus, specific_skus)',
  `price_setting_mode` varchar(32) NOT NULL DEFAULT 'unified' COMMENT '价格设置模式 (unified, individual)',
  `stock_management_mode` varchar(32) NOT NULL DEFAULT 'unified' COMMENT '库存管理模式 (unified, individual)',
  
  -- 时间设置
  `start_time` datetime COMMENT '商品参与开始时间',
  `end_time` datetime COMMENT '商品参与结束时间',
  
  -- 状态
  `status` varchar(32) NOT NULL DEFAULT 'pending' COMMENT '商品状态 (pending, approved, rejected, active, ended)',
  `is_show` tinyint(1) DEFAULT 1 COMMENT '是否展示',
  
  -- 数据统计
  `activity_sales_volume` int DEFAULT 0 COMMENT '活动销量',
  `activity_sales_amount` decimal(12,2) DEFAULT 0.00 COMMENT '活动销售金额',
  
  -- 操作信息
  `version` bigint(20) unsigned DEFAULT 0 COMMENT '版本号',
  `creator_type` varchar(64) COMMENT '创建者类型',
  `creator_id` varchar(64) COMMENT '创建者ID',
  `creator_name` varchar(255) COMMENT '创建者名称',
  `updater_type` varchar(64) COMMENT '更新者类型',
  `updater_id` varchar(64) COMMENT '更新者ID',
  `updater_name` varchar(255) COMMENT '更新者名称',
  `created_at` timestamp NULL DEFAULT NULL COMMENT '创建时间',
  `updated_at` timestamp NULL DEFAULT NULL COMMENT '更新时间',
  `deleted_at` timestamp NULL DEFAULT NULL COMMENT '删除时间',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_activity_product` (`activity_id`, `product_id`),
  KEY `idx_activity` (`activity_id`),
  KEY `idx_product` (`product_id`),
  KEY `idx_seller` (`seller_type`, `seller_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='活动商品表';
```

### 3. 活动SKU表 (promotion_activity_skus)

```sql
CREATE TABLE `promotion_activity_skus` (
  `id` bigint(20) unsigned NOT NULL COMMENT 'ID',
  `activity_id` bigint(20) unsigned NOT NULL COMMENT '活动ID',
  `product_id` bigint(20) unsigned NOT NULL COMMENT '商品ID',
  `sku_id` bigint(20) unsigned NOT NULL COMMENT 'SKU ID',
  `activity_product_id` bigint(20) unsigned NOT NULL COMMENT '活动商品ID',
  
  -- SKU信息
  `properties_name` varchar(255) COMMENT '规格名称',
  `image` varchar(500) COMMENT 'SKU主图',
  `original_price` decimal(10,2) NOT NULL COMMENT '原价',
  
  -- 活动设置 (独立设置模式)
  `activity_price` decimal(10,2) COMMENT '活动价',
  `discount_rate` decimal(5,2) COMMENT '折扣率',
  `activity_stock` int COMMENT '活动库存',
  `locked_stock` int DEFAULT 0 COMMENT '已锁定库存',
  `user_purchase_limit` int COMMENT '单用户限购数量',
  
  -- 状态
  `status` varchar(32) NOT NULL DEFAULT 'active' COMMENT 'SKU状态 (active, inactive)',
  `is_show` tinyint(1) DEFAULT 1 COMMENT '是否展示',
  
  -- 数据统计
  `activity_sales_volume` int DEFAULT 0 COMMENT '活动销量',
  `activity_sales_amount` decimal(12,2) DEFAULT 0.00 COMMENT '活动销售金额',
  
  -- 操作信息
  `version` bigint(20) unsigned DEFAULT 0 COMMENT '版本号',
  `creator_type` varchar(64) COMMENT '创建者类型',
  `creator_id` varchar(64) COMMENT '创建者ID',
  `creator_name` varchar(255) COMMENT '创建者名称',
  `updater_type` varchar(64) COMMENT '更新者类型',
  `updater_id` varchar(64) COMMENT '更新者ID',
  `updater_name` varchar(255) COMMENT '更新者名称',
  `created_at` timestamp NULL DEFAULT NULL COMMENT '创建时间',
  `updated_at` timestamp NULL DEFAULT NULL COMMENT '更新时间',
  `deleted_at` timestamp NULL DEFAULT NULL COMMENT '删除时间',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_activity_sku` (`activity_id`, `sku_id`),
  KEY `idx_activity` (`activity_id`),
  KEY `idx_product` (`product_id`),
  KEY `idx_sku` (`sku_id`),
  KEY `idx_activity_product` (`activity_product_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='活动SKU表';
```

### 4. 活动用户参与记录表 (promotion_activity_participations)

```sql
CREATE TABLE `promotion_activity_participations` (
  `id` bigint(20) unsigned NOT NULL COMMENT 'ID',
  `activity_id` bigint(20) unsigned NOT NULL COMMENT '活动ID',
  `product_id` bigint(20) unsigned NOT NULL COMMENT '商品ID',
  `sku_id` bigint(20) unsigned COMMENT 'SKU ID',
  `user_type` varchar(64) NOT NULL COMMENT '用户类型',
  `user_id` varchar(64) NOT NULL COMMENT '用户ID',
  `user_name` varchar(255) COMMENT '用户名称',
  
  -- 参与信息
  `order_no` varchar(64) COMMENT '订单号',
  `quantity` int NOT NULL DEFAULT 1 COMMENT '参与数量',
  `amount` decimal(10,2) NOT NULL COMMENT '参与金额',
  `participated_at` timestamp NULL DEFAULT NULL COMMENT '参与时间',
  
  -- 活动信息快照
  `activity_price` decimal(10,2) COMMENT '活动价格快照',
  `discount_rate` decimal(5,2) COMMENT '折扣率快照',
  
  -- 状态
  `status` varchar(32) NOT NULL DEFAULT 'participated' COMMENT '参与状态 (participated, ordered, completed, cancelled)',
  
  -- 操作信息
  `version` bigint(20) unsigned DEFAULT 0 COMMENT '版本号',
  `creator_type` varchar(64) COMMENT '创建者类型',
  `creator_id` varchar(64) COMMENT '创建者ID',
  `creator_name` varchar(255) COMMENT '创建者名称',
  `updater_type` varchar(64) COMMENT '更新者类型',
  `updater_id` varchar(64) COMMENT '更新者ID',
  `updater_name` varchar(255) COMMENT '更新者名称',
  `created_at` timestamp NULL DEFAULT NULL COMMENT '创建时间',
  `updated_at` timestamp NULL DEFAULT NULL COMMENT '更新时间',
  `deleted_at` timestamp NULL DEFAULT NULL COMMENT '删除时间',
  
  PRIMARY KEY (`id`),
  KEY `idx_activity` (`activity_id`),
  KEY `idx_user` (`user_type`, `user_id`),
  KEY `idx_product` (`product_id`),
  KEY `idx_sku` (`sku_id`),
  KEY `idx_order` (`order_no`),
  KEY `idx_participated_at` (`participated_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='活动用户参与记录表';
```

### 5. 活动统计表 (promotion_activity_statistics)

```sql
CREATE TABLE `promotion_activity_statistics` (
  `id` bigint(20) unsigned NOT NULL COMMENT 'ID',
  `activity_id` bigint(20) unsigned NOT NULL COMMENT '活动ID',
  
  -- 参与数据
  `total_participants` int DEFAULT 0 COMMENT '总参与人数',
  `total_participation_times` int DEFAULT 0 COMMENT '总参与次数',
  `total_products` int DEFAULT 0 COMMENT '参与商品数',
  `total_skus` int DEFAULT 0 COMMENT '参与SKU数',
  
  -- 销售数据
  `total_orders` int DEFAULT 0 COMMENT '总订单数',
  `total_sales_volume` int DEFAULT 0 COMMENT '总销量',
  `total_sales_amount` decimal(12,2) DEFAULT 0.00 COMMENT '总销售额',
  `total_discount_amount` decimal(12,2) DEFAULT 0.00 COMMENT '总优惠金额',
  
  -- 用户数据
  `new_user_participants` int DEFAULT 0 COMMENT '新用户参与数',
  `member_user_participants` int DEFAULT 0 COMMENT '会员用户参与数',
  
  -- 转化数据
  `page_views` int DEFAULT 0 COMMENT '页面浏览量',
  `conversion_rate` decimal(5,4) DEFAULT 0.0000 COMMENT '转化率',
  
  -- 时间统计
  `daily_stats` json COMMENT '每日统计数据',
  `updated_at` timestamp NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_activity` (`activity_id`),
  KEY `idx_activity` (`activity_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='活动统计表';
```

### 6. 索引优化建议

```sql
-- 优化活动查询
CREATE INDEX idx_activities_status_time ON promotion_activities(status, start_time, end_time);

-- 优化商品查询
CREATE INDEX idx_products_activity_status ON promotion_activity_products(activity_id, status);

-- 优化SKU查询
CREATE INDEX idx_skus_activity_product ON promotion_activity_skus(activity_id, product_id);

-- 优化用户参与查询
CREATE INDEX idx_participations_user_activity ON promotion_activity_participations(user_id, activity_id);

-- 优化统计查询
CREATE INDEX idx_statistics_sales ON promotion_activity_statistics(total_sales_amount DESC);
```

### 7. 分区策略建议

```sql
-- 按时间对活动表进行分区
ALTER TABLE promotion_activities PARTITION BY RANGE (YEAR(start_time)) (
  PARTITION p2023 VALUES LESS THAN (2024),
  PARTITION p2024 VALUES LESS THAN (2025),
  PARTITION p2025 VALUES LESS THAN (2026),
  PARTITION p_future VALUES LESS THAN MAXVALUE
);

-- 按时间对参与记录表进行分区
ALTER TABLE promotion_activity_participations PARTITION BY RANGE (YEAR(participated_at)) (
  PARTITION p2023 VALUES LESS THAN (2024),
  PARTITION p2024 VALUES LESS THAN (2025),
  PARTITION p2025 VALUES LESS THAN (2026),
  PARTITION p_future VALUES LESS THAN MAXVALUE
);
```