# Project 项目领域扩展包提示词（开箱即用蓝图）

基于 Red Jasmine Framework，构建"组织-项目-成员-角色"核心域的 Composer 扩展包，满足 80% 通用场景并保留充足扩展点。

## 核心定义

### 领域边界
项目领域负责管理企业组织内的项目生命周期，包括：
- **项目管理**：项目的创建、配置、激活、归档等生命周期管理
- **成员管理**：项目成员的加入、角色分配、权限管理
- **多租户隔离**：基于项目的数据隔离和配置隔离

### 核心概念
- **项目（Project）**：企业组织创建的服务载体，默认开通所有业务服务
- **项目成员（ProjectMember）**：项目内的用户，具有特定角色和权限
- **项目角色（ProjectRole）**：定义成员在项目中的权限和职责

### 依赖关系
- **多态关联**：通过 `owner_type` 和 `owner_id` 关联企业组织，支持多种组织类型
- **成员关联**：通过 `member_type` 和 `member_id` 关联成员，支持多种成员类型
- **被其他领域依赖**：其他业务领域通过 `project_id` 实现数据隔离

### 多态关联优势
- **解耦设计**：项目包不依赖特定的组织包，可以独立开发和部署
- **灵活扩展**：支持多种组织类型（企业、团队、个人等）
- **成员扩展**：支持多种成员类型（用户、管理员、系统账户等）
- **易于集成**：其他系统可以轻松集成项目功能

## 数据库表设计

### projects（项目核心表）
```sql
CREATE TABLE projects (
    id BIGINT UNSIGNED PRIMARY KEY,
    owner_type VARCHAR(255) NOT NULL, -- 多态关联：组织类型
    owner_id BIGINT UNSIGNED NOT NULL, -- 多态关联：组织ID
    parent_id BIGINT UNSIGNED NULL, -- 支持项目分组
    name VARCHAR(255) NOT NULL,
    short_name VARCHAR(100) NULL,
    description TEXT NULL,
    code VARCHAR(100) NOT NULL, -- 所有者内唯一
    project_type ENUM('standard', 'template', 'temporary') DEFAULT 'standard',
    status ENUM('draft', 'active', 'paused', 'archived') DEFAULT 'draft',
    sort INT DEFAULT 0,
    config JSON NULL, -- 项目配置
    created_at TIMESTAMP NULL,
    updated_at TIMESTAMP NULL,
    deleted_at TIMESTAMP NULL,
    
    UNIQUE KEY uk_owner_code (owner_type, owner_id, code),
    KEY idx_owner_status (owner_type, owner_id, status),
    KEY idx_parent (parent_id),
    KEY idx_nested (lft, rgt, depth)
);
```


### project_members（项目成员表）
```sql
CREATE TABLE project_members (
    id BIGINT UNSIGNED PRIMARY KEY,
    project_id BIGINT UNSIGNED NOT NULL,
    member_type VARCHAR(255) NOT NULL, -- 多态关联：成员类型
    member_id BIGINT UNSIGNED NOT NULL, -- 多态关联：成员ID
    status ENUM('pending', 'active', 'paused', 'left') DEFAULT 'pending',
    joined_at TIMESTAMP NULL,
    left_at TIMESTAMP NULL,
    permissions JSON NULL,
    created_at TIMESTAMP NULL,
    updated_at TIMESTAMP NULL,
    
    UNIQUE KEY uk_project_member_active (project_id, member_type, member_id, left_at),
    KEY idx_member_project (member_type, member_id, project_id),
);
```

### project_roles（项目角色表）
```sql
CREATE TABLE project_roles (
    id BIGINT UNSIGNED PRIMARY KEY,
    project_id BIGINT UNSIGNED NULL, -- NULL表示全局角色
    name VARCHAR(255) NOT NULL,
    code VARCHAR(100) NOT NULL,
    description VARCHAR(255) NOT NULL,
    is_system BOOLEAN DEFAULT FALSE,
    permissions JSON NULL,
    sort INT DEFAULT 0,
    status ENUM('active', 'inactive') DEFAULT 'active',
    created_at TIMESTAMP NULL,
    updated_at TIMESTAMP NULL,
    
    UNIQUE KEY uk_project_code (project_id, code),
    KEY idx_project_status (project_id, status)
);
```

## 领域层设计

### 模型定义

#### Project 模型（核心聚合根）
```php
class Project extends Model implements OperatorInterface, OwnerInterface
{
    use HasSnowflakeId;
    use HasOwner;
    use HasOperator;
    use SoftDeletes;
    use NodeTrait; // NestedSet

    protected $fillable = [
        'owner_type', 'owner_id', 'parent_id', 'name', 'short_name', 'description',
        'code', 'project_type', 'status', 'sort', 'depth',
        'config', 'billing_config'
    ];

    protected $casts = [
        'config' => 'array',
        'billing_config' => 'array',
        'status' => ProjectStatus::class,
        'project_type' => ProjectType::class,
    ];

    // 关联关系
    public function owner() { return $this->morphTo(); }
    public function parent() { return $this->belongsTo(Project::class, 'parent_id'); }
    public function children() { return $this->hasMany(Project::class, 'parent_id'); }
    public function members() { return $this->hasMany(ProjectMember::class); }
    public function roles() { return $this->hasMany(ProjectRole::class); }

    // 业务方法
    public function addMember($member, ProjectRole $role): ProjectMember
    public function removeMember($member): bool
    public function updateMemberRole($member, ProjectRole $role): ProjectMember
    public function hasPermission($member, string $permission): bool
}
```


#### ProjectMember 模型
```php
class ProjectMember extends Model
{
    use HasSnowflakeId;

    protected $fillable = [
        'project_id', 'member_type', 'member_id',  'status',
        'joined_at', 'left_at', 
    ];

    protected $casts = [
        'status' => ProjectMemberStatus::class,
        'joined_at' => 'datetime',
        'left_at' => 'datetime',
    ];

    // 关联关系
    public function project() { return $this->belongsTo(Project::class); }
    public function member() { return $this->morphTo(); }
    public function role() { return $this->belongsTo(ProjectRole::class); }
    public function inviter() { return $this->morphTo('invited_by'); }

    // 业务方法
    public function hasPermission(string $permission): bool
    public function updateRole(ProjectRole $role): bool
    public function leave(): bool
    public function activate(): bool
    public function pause(): bool
}
```

#### ProjectRole 模型
```php
class ProjectRole extends Model
{
    use HasSnowflakeId;

    protected $fillable = [
        'project_id', 'name', 'code', 'description',
        'is_system', 'permissions', 'sort', 'status'
    ];

    protected $casts = [
        'permissions' => 'array',
        'is_system' => 'boolean',
        'status' => ProjectRoleStatus::class,
    ];

    // 关联关系
    public function project() { return $this->belongsTo(Project::class); }
    public function members() { return $this->hasMany(ProjectMember::class); }

    // 业务方法
    public function hasPermission(string $permission): bool
    public function addPermission(string $permission): bool
    public function removePermission(string $permission): bool
}
```

#### ProjectMemberStatus 枚举
```php
enum ProjectMemberStatus: string
{
    use EnumsHelper;

    case PENDING = 'pending';
    case ACTIVE = 'active';
    case PAUSED = 'paused';
    case LEFT = 'left';

    public static function labels(): array
    {
        return [
            self::PENDING->value => '待确认',
            self::ACTIVE->value => '正常',
            self::PAUSED->value => '暂停',
            self::LEFT->value => '已退出',
        ];
    }
}
```

#### ProjectRoleStatus 枚举
```php
enum ProjectRoleStatus: string
{
    use EnumsHelper;

    case ACTIVE = 'active';
    case INACTIVE = 'inactive';

    public static function labels(): array
    {
        return [
            self::ACTIVE->value => '激活',
            self::INACTIVE->value => '禁用',
        ];
    }
}
```

### 枚举定义

#### ProjectStatus 枚举
```php
enum ProjectStatus: string
{
    use EnumsHelper;

    case DRAFT = 'draft';
    case ACTIVE = 'active';
    case PAUSED = 'paused';
    case ARCHIVED = 'archived';

    public static function labels(): array
    {
        return [
            self::DRAFT->value => '草稿',
            self::ACTIVE->value => '激活',
            self::PAUSED->value => '暂停',
            self::ARCHIVED->value => '归档',
        ];
    }
}
```

#### ProjectType 枚举
```php
enum ProjectType: string
{
    use EnumsHelper;

    case STANDARD = 'standard';
    case TEMPLATE = 'template';
    case TEMPORARY = 'temporary';

    public static function labels(): array
    {
        return [
            self::STANDARD->value => '标准项目',
            self::TEMPLATE->value => '模板项目',
            self::TEMPORARY->value => '临时项目',
        ];
    }
}
```


### 事件定义

#### 项目生命周期事件
```php
class ProjectCreated
{
    public function __construct(
        public Project $project,
        public UserInterface $creator
    ) {}
}

class ProjectActivated
{
    public function __construct(
        public Project $project,
        public UserInterface $operator
    ) {}
}

class ProjectArchived
{
    public function __construct(
        public Project $project,
        public UserInterface $operator
    ) {}
}
```


#### 成员管理事件
```php
class MemberJoined
{
    public function __construct(
        public Project $project,
        public ProjectMember $member,
        public UserInterface $inviter
    ) {}
}

class MemberRoleChanged
{
    public function __construct(
        public Project $project,
        public ProjectMember $member,
        public ProjectRole $oldRole,
        public ProjectRole $newRole,
        public UserInterface $operator
    ) {}
}
```

### 仓库接口

#### ProjectRepositoryInterface
```php
interface ProjectRepositoryInterface extends RepositoryInterface
{
    public function findByOwner(string $ownerType, string $ownerId): Collection;
    public function findByCode(string $ownerType, string $ownerId, string $code): ?Project;
    public function findMembers(string $projectId): Collection;
    public function findRoles(string $projectId): Collection;
    public function findMemberByProjectAndMember(string $projectId, string $memberType, string $memberId): ?ProjectMember;
    public function findRoleByProjectAndCode(string $projectId, string $code): ?ProjectRole;
}
```


### 外部服务接口


#### ProjectPermissionProviderInterface
```php
interface ProjectPermissionProviderInterface
{
    public function hasPermission(Project $project, $member, string $permission): bool;
    public function getPermissions(Project $project, $member): array;
    public function getRolePermissions(ProjectRole $role): array;
}
```

## 应用层设计

### 应用服务

#### ProjectApplicationService
```php
class ProjectApplicationService extends ApplicationService
{
    public static string $hookNamePrefix = 'project.application';
    protected static string $modelClass = Project::class;
    
    public function __construct(
        public ProjectRepositoryInterface $repository,
        public ProjectTransformer $transformer
    ) {
    }
    
    protected static $macros = [
        'create' => ProjectCreateCommandHandler::class,
        'update' => ProjectUpdateCommandHandler::class,
        'activate' => ProjectActivateCommandHandler::class,
        'archive' => ProjectArchiveCommandHandler::class,
        'addMember' => ProjectAddMemberCommandHandler::class,
        'removeMember' => ProjectRemoveMemberCommandHandler::class,
        'updateMemberRole' => ProjectUpdateMemberRoleCommandHandler::class,
        'createRole' => ProjectCreateRoleCommandHandler::class,
        'updateRole' => ProjectUpdateRoleCommandHandler::class,
        'deleteRole' => ProjectDeleteRoleCommandHandler::class,
    ];
}
```

### 命令定义

#### ProjectCreateCommand
```php
class ProjectCreateCommand extends ProjectData
{
    public UserInterface $owner;
    public string $ownerType;
    public string $ownerId;
    public string $name;
    public string $code;
    public ProjectType $type;
    public ?string $parentId = null;
    public array $config = [];
}
```


#### ProjectAddMemberCommand
```php
class ProjectAddMemberCommand extends Data
{
    public UserInterface $owner;
    public string $projectId;
    public string $memberType;
    public string $memberId;
    public string $roleId;
    public ?string $invitedByType = null;
    public ?string $invitedById = null;
}
```

#### ProjectUpdateMemberRoleCommand
```php
class ProjectUpdateMemberRoleCommand extends Data
{
    public UserInterface $owner;
    public string $projectId;
    public string $memberType;
    public string $memberId;
    public string $roleId;
}
```

#### ProjectCreateRoleCommand
```php
class ProjectCreateRoleCommand extends Data
{
    public UserInterface $owner;
    public string $projectId;
    public string $name;
    public string $code;
    public string $description;
    public array $permissions = [];
    public int $sort = 0;
}
```

### 命令处理器

#### ProjectCreateCommandHandler
```php
class ProjectCreateCommandHandler extends CommandHandler
{
    public function __construct(
        protected ProjectApplicationService $service
    ) {
    }

    public function handle(ProjectCreateCommand $command): Project
    {
        $this->beginDatabaseTransaction();
        
        try {
            $model = $this->service->newModel();
            $model = $this->service->transformer->transform($command, $model);
            $this->service->repository->store($model);
            
            
            $this->commitDatabaseTransaction();
            return $model;
        } catch (Throwable $throwable) {
            $this->rollBackDatabaseTransaction();
            throw $throwable;
        }
    }
}
```

### 查询定义

#### ProjectListQuery
```php
class ProjectListQuery extends PaginateQuery
{
    public ?string $ownerType = null;
    public ?string $ownerId = null;
    public ?ProjectStatus $status = null;
    public ?ProjectType $type = null;
    public ?string $name = null;
    public ?string $code = null;
    public ?string $parentId = null;
}
```

#### ProjectMemberListQuery
```php
class ProjectMemberListQuery extends PaginateQuery
{
    public string $projectId;
    public ?ProjectMemberStatus $status = null;
    public ?string $roleId = null;
    public ?string $memberType = null;
    public ?string $memberId = null;
}
```

#### ProjectRoleListQuery
```php
class ProjectRoleListQuery extends PaginateQuery
{
    public string $projectId;
    public ?ProjectRoleStatus $status = null;
    public ?string $name = null;
    public ?string $code = null;
}
```

### 查询处理器

#### ProjectListQueryHandler
```php
class ProjectListQueryHandler extends QueryHandler
{
    public function __construct(
        protected ProjectRepositoryInterface $repository
    ) {
    }

    public function handle(ProjectListQuery $query): LengthAwarePaginator
    {
        return $this->repository->paginate($query);
    }
}
```

#### ProjectMemberListQueryHandler
```php
class ProjectMemberListQueryHandler extends QueryHandler
{
    public function __construct(
        protected ProjectRepositoryInterface $repository
    ) {
    }

    public function handle(ProjectMemberListQuery $query): LengthAwarePaginator
    {
        return $this->repository->findMembers($query->projectId)
                               ->where('status', $query->status)
                               ->where('role_id', $query->roleId)
                               ->paginate($query->perPage);
    }
}
```

#### ProjectRoleListQueryHandler
```php
class ProjectRoleListQueryHandler extends QueryHandler
{
    public function __construct(
        protected ProjectRepositoryInterface $repository
    ) {
    }

    public function handle(ProjectRoleListQuery $query): LengthAwarePaginator
    {
        return $this->repository->findRoles($query->projectId)
                               ->where('status', $query->status)
                               ->where('name', 'like', "%{$query->name}%")
                               ->paginate($query->perPage);
    }
}
```

## 与其他领域的组合集成方式

### 与组织架构包集成
```php
// 在组织模型中添加项目关联（多态关联）
class Organization extends Model
{
    public function projects()
    {
        return $this->morphMany(Project::class, 'owner');
    }
}

// 在成员模型中添加项目成员关联（多态关联）
class Member extends Model
{
    public function projectMembers()
    {
        return $this->morphMany(ProjectMember::class, 'member');
    }
    
    public function projects()
    {
        return $this->belongsToMany(Project::class, 'project_members', 'member_id', 'project_id')
                    ->wherePivot('member_type', static::class)
                    ->withPivot(['role_id', 'status', 'joined_at']);
    }
}
```

### 与其他业务领域集成
```php
// 商品领域通过项目ID实现数据隔离
class Product extends Model
{
    public function project()
    {
        return $this->belongsTo(Project::class);
    }
    
    // 查询作用域：只查询当前项目的商品
    public function scopeForProject($query, string $projectId)
    {
        return $query->where('project_id', $projectId);
    }
}

// 订单领域通过项目ID实现数据隔离
class Order extends Model
{
    public function project()
    {
        return $this->belongsTo(Project::class);
    }
    
    public function scopeForProject($query, string $projectId)
    {
        return $query->where('project_id', $projectId);
    }
}
```

### 权限集成
```php
// 在控制器中使用项目权限检查
class ProductController extends Controller
{
    public function index(Request $request)
    {
        $projectId = $request->get('project_id');
        
        // 检查用户是否有项目访问权限
        $this->authorize('view', [Project::class, $projectId]);
        
        // 使用项目作用域查询数据
        $products = Product::forProject($projectId)->paginate();
        
        return response()->json($products);
    }
}
```


这个项目领域包提示词提供了完整的项目管理系统设计，与组织架构包无缝集成，支持多租户、多角色的复杂业务场景。项目默认开通所有服务，简化了服务管理复杂度。
